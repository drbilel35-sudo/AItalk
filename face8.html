<meta name='viewport' content='width=device-width, initial-scale=1'/> <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Real-time Voice & Expressions</title>
    <meta name="description" content="Real-time conversational AI with animated face and voice interaction">
    <meta name="theme-color" content="#4a6fa5">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #4a6fa5);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            cursor: default;
            overflow-x: hidden;
        }

        /* App Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(26, 42, 108, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .header-text {
            text-align: left;
        }

        .app-title {
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #fff, #a8d8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .status-online {
            color: #4ade80;
        }

        .status-offline {
            color: #f87171;
        }

        .status-groq {
            color: #10b981 !important;
        }

        .status-openai {
            color: #8b5cf6 !important;
        }

        .status-local {
            color: #f59e0b !important;
        }

        /* Main App Layout */
        .app-container {
            display: flex;
            flex: 1;
            margin-top: 70px;
            height: calc(100vh - 70px);
        }

        /* Fixed Face Section */
        .face-section {
            position: fixed;
            left: 0;
            top: 70px;
            width: 350px;
            height: calc(100vh - 70px);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 900;
            overflow-y: auto;
        }

        .face-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .face-wrapper {
            position: relative;
            width: 280px;
            height: 280px;
        }

        .human-face {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            object-fit: cover;
        }

        /* Eye Tracking System */
        .eye-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .eye {
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 3px rgba(0,0,0,0.25);
        }

        .eye-left {
            top: 28%;
            left: 39.4%;
        }

        .eye-right {
            top: 28%;
            left: 54.1%;
        }

        .pupil {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #1a2a6c;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.12s ease-out;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        /* Mouth */
        .mouth {
            position: absolute;
            top: 44.5%;
            left: 46%;
            transform: translateX(-50%);
            width: 20px;
            height: 10px;
            background: #ff6b8b;
            border-radius: 50%;
            display: none;
            z-index: 6;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }

        .face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            mix-blend-mode: overlay;
            z-index: 2;
        }

        .face-overlay.active {
            opacity: 0.6;
        }

        .face-status {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 8px;
            margin: 0 15px;
            z-index: 3;
            font-size: 0.8rem;
        }

        .expression-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 3;
        }

        .robot-info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            z-index: 3;
        }

        /* Controls Panel */
        .controls-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
        }

        .instruction-input {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        input, select {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            outline: none;
            color: #333;
        }

        button {
            padding: 10px 15px;
            background: #4a6fa5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover {
            background: #5a7fb5;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(1px);
        }

        .voice-btn {
            background: #ff6b6b;
            width: 100%;
            justify-content: center;
            margin-top: 8px;
        }

        .voice-btn:hover {
            background: #ff7b7b;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.85rem;
        }

        .commands {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 12px;
        }

        .command-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .command-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.03);
        }

        /* Scrollable Content Section */
        .content-section {
            margin-left: 350px;
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
            padding: 20px;
            overflow-y: auto;
            position: relative;
            z-index: 800;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.9rem;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: rgba(74, 111, 165, 0.7);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .robot-message {
            background: rgba(255, 255, 255, 0.2);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-input {
            display: flex;
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
        }

        .conversation-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .conversation-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
        }

        .api-key-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .api-key-input {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .api-key-input input {
            flex: 1;
        }

        .voice-test {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            text-align: center;
        }

        .voice-test-btn {
            width: 100%;
            margin-top: 5px;
        }

        /* Debug Info */
        .debug-info {
            background: rgba(255, 0, 0, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.8rem;
            border-left: 3px solid #ff6b6b;
        }

        .debug-success {
            background: rgba(76, 175, 80, 0.1);
            border-left: 3px solid #4ade80;
        }

        /* Provider Info */
        .provider-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .provider-info ul {
            margin: 5px 0 0 15px;
        }

        .provider-info li {
            margin-bottom: 3px;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .face-section {
                width: 300px;
            }
            
            .content-section {
                margin-left: 300px;
            }
            
            .face-wrapper {
                width: 240px;
                height: 240px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .face-section {
                position: relative;
                width: 100%;
                height: auto;
                top: 0;
            }
            
            .content-section {
                margin-left: 0;
                height: auto;
            }
            
            .app-header {
                padding: 10px 15px;
            }
            
            .app-container {
                margin-top: 60px;
                height: auto;
            }
        }
    </style>
</head>
<body>
    <!-- Fixed App Header -->
    <header class="app-header">
        <div class="logo-header">
            <svg class="logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="faceGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#667eea" />
                        <stop offset="100%" stop-color="#764ba2" />
                    </linearGradient>
                    <radialGradient id="eyeGradient" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" stop-color="#ffffff" />
                        <stop offset="100%" stop-color="#f0f8ff" />
                    </radialGradient>
                </defs>
                <circle cx="100" cy="100" r="80" fill="url(#faceGradient)" stroke="#fff" stroke-width="2"/>
                <ellipse cx="75" cy="85" rx="12" ry="15" fill="url(#eyeGradient)"/>
                <ellipse cx="125" cy="85" rx="12" ry="15" fill="url(#eyeGradient)"/>
                <circle cx="75" cy="85" r="6" fill="#1a2a6c"/>
                <circle cx="125" cy="85" r="6" fill="#1a2a6c"/>
                <path d="M70 120 Q100 140 130 120" stroke="#ff6b8b" stroke-width="6" stroke-linecap="round" fill="none"/>
            </svg>
            
            <div class="header-text">
                <h1 class="app-title">AI Assistant</h1>
            </div>
        </div>
        
        <div class="connection-status" id="connection-status">
            <i class="fas fa-microchip status-local"></i>
            <span>AI: Local Mode</span>
        </div>
    </header>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Fixed Left Panel with Face -->
        <div class="face-section">
            <div class="face-container">
                <div class="face-wrapper">
                    <img src="https://i.postimg.cc/jqgvh4sg/IMG-20251123-WA0008.jpg" 
                         alt="AI Assistant" class="human-face" id="human-face">
                    
                    <!-- Eye Tracking System -->
                    <div class="eye-container">
                        <div class="eye eye-left">
                            <div class="pupil" id="pupil-left"></div>
                        </div>
                        <div class="eye eye-right">
                            <div class="pupil" id="pupil-right"></div>
                        </div>
                    </div>
                    
                    <!-- Expression overlays -->
                    <div class="face-overlay" id="happy-overlay" style="background: linear-gradient(45deg, rgba(255,255,0,0.3), rgba(255,165,0,0.3));"></div>
                    <div class="face-overlay" id="sad-overlay" style="background: linear-gradient(45deg, rgba(0,0,255,0.3), rgba(128,0,128,0.3));"></div>
                    <div class="face-overlay" id="thinking-overlay" style="background: linear-gradient(45deg, rgba(128,0,128,0.3), rgba(75,0,130,0.3));"></div>
                    <div class="face-overlay" id="excited-overlay" style="background: linear-gradient(45deg, rgba(255,0,0,0.3), rgba(255,165,0,0.3));"></div>
                    
                    <!-- Lip sync element -->
                    <div class="mouth" id="mouth"></div>

                    <!-- Status Indicators -->
                    <div class="expression-indicator" id="expression-indicator">
                        <i class="fas fa-smile" id="expression-icon"></i>
                        <span id="expression-text">Ready</span>
                    </div>
                    
                    <div class="robot-info" id="robot-info">
                        <div>AI: <span id="ai-status">Local</span></div>
                        <div>Voice: <span id="voice-status">Ready</span></div>
                    </div>
                    
                    <div class="face-status" id="face-status">
                        <div>Status: <span id="current-status">Online</span></div>
                        <div>Mood: <span id="current-mood">Neutral</span></div>
                    </div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="controls-panel">
                <div class="instruction-input">
                    <input type="text" id="instruction-input" placeholder="Ask me anything...">
                    <button id="execute-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
                
                <button id="voice-btn" class="voice-btn"><i class="fas fa-microphone"></i> Voice Command</button>
                
                <div class="status" id="status">Ready to assist you!</div>
                
                <div class="commands">
                    <div class="command-btn" data-command="greet">
                        <i class="fas fa-hand-wave"></i>
                        <span>Greet</span>
                    </div>
                    <div class="command-btn" data-command="joke">
                        <i class="fas fa-laugh"></i>
                        <span>Joke</span>
                    </div>
                    <div class="command-btn" data-command="fact">
                        <i class="fas fa-lightbulb"></i>
                        <span>Fact</span>
                    </div>
                    <div class="command-btn" data-command="time">
                        <i class="fas fa-clock"></i>
                        <span>Time</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scrollable Right Content -->
        <div class="content-section">
            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message robot-message">
                        Hello! I'm your AI assistant. Configure your AI provider below to get started!
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Type your message here...">
                    <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="conversation-controls">
                    <button id="clear-chat-btn" class="conversation-btn"><i class="fas fa-trash"></i> Clear Chat</button>
                    <button id="test-connection-btn" class="conversation-btn"><i class="fas fa-plug"></i> Test Connection</button>
                </div>
            </div>

            <!-- Configuration Section -->
            <div class="api-key-section">
                <h3><i class="fas fa-key"></i> AI Configuration</h3>
                
                <!-- AI Provider Selection -->
                <div class="provider-selection" style="margin-bottom: 15px;">
                    <label>AI Provider:</label>
                    <select id="ai-provider" style="width: 100%; padding: 8px; border-radius: 6px; margin-top: 5px; background: rgba(255,255,255,0.9); color: #333;">
                        <option value="local">Local AI Only</option>
                        <option value="groq">Groq (Llama 3 - Free & Fast)</option>
                        <option value="openai">OpenAI (GPT-3.5/4)</option>
                    </select>
                </div>
                
                <!-- Provider Information -->
                <div class="provider-info" id="provider-info">
                    <strong>Groq (Recommended):</strong>
                    <ul>
                        <li>‚úÖ Completely free during beta</li>
                        <li>‚úÖ No credit card required</li>
                        <li>‚úÖ Lightning fast responses</li>
                        <li>Get API key: <a href="https://console.groq.com" target="_blank" style="color: #4ade80;">console.groq.com</a></li>
                    </ul>
                </div>
                
                <!-- API Key Input -->
                <div id="api-key-fields" style="margin-top: 15px;">
                    <div class="api-key-input">
                        <input type="password" id="api-key-input" placeholder="No API key needed for local AI">
                        <button id="save-api-key-btn"><i class="fas fa-save"></i> Save</button>
                    </div>
                </div>

                <!-- Debug Section -->
                <div id="debug-section">
                    <div class="debug-info" id="debug-info">
                        No debug information yet. Test your connection to see details.
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button id="enable-voice-btn" class="voice-btn"><i class="fas fa-microphone-alt"></i> Enable Voice</button>
                    <button id="continuous-mode-btn" class="voice-btn"><i class="fas fa-comments"></i> Continuous Mode</button>
                </div>
                
                <div class="voice-test">
                    <p><strong>Voice Test:</strong> Check if speech synthesis works</p>
                    <button id="test-voice-btn" class="voice-test-btn voice-btn">
                        <i class="fas fa-volume-up"></i> Test Voice
                    </button>
                    <div id="voice-debug" style="margin-top: 8px; font-size: 0.8rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const humanFace = document.getElementById('human-face');
        const instructionInput = document.getElementById('instruction-input');
        const executeBtn = document.getElementById('execute-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const status = document.getElementById('status');
        const commandBtns = document.querySelectorAll('.command-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const testConnectionBtn = document.getElementById('test-connection-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        const aiProviderSelect = document.getElementById('ai-provider');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const connectionStatus = document.getElementById('connection-status');
        const enableVoiceBtn = document.getElementById('enable-voice-btn');
        const continuousModeBtn = document.getElementById('continuous-mode-btn');
        const testVoiceBtn = document.getElementById('test-voice-btn');
        const voiceDebug = document.getElementById('voice-debug');
        const mouth = document.getElementById('mouth');
        const pupilLeft = document.getElementById('pupil-left');
        const pupilRight = document.getElementById('pupil-right');
        const debugInfo = document.getElementById('debug-info');

        // State variables
        let aiConfig = {
            provider: localStorage.getItem('ai-provider') || 'local',
            apiKey: localStorage.getItem('ai-api-key') || '',
            enabled: false,
            actuallyWorking: false // NEW: Track if API actually works
        };

        let isTalking = false;
        let currentExpression = 'neutral';
        let voiceEnabled = true;
        let continuousMode = false;
        let expressionTimeout = null;
        let conversationHistory = [];
        let speechSupported = false;

        // Enhanced AI Knowledge Base
        const knowledgeBase = {
            greetings: {
                patterns: ['hello', 'hi', 'hey', 'greetings'],
                responses: [
                    "Hello! I'm your AI assistant. How can I help you today?",
                    "Hi there! I'm ready to assist you.",
                    "Greetings! I'm your AI companion here to help you."
                ],
                expression: 'happy'
            },
            jokes: {
                patterns: ['joke', 'funny', 'laugh'],
                responses: [
                    "Why don't scientists trust atoms? Because they make up everything!",
                    "Why did the scarecrow win an award? He was outstanding in his field!",
                    "What do you call a fake noodle? An impasta!"
                ],
                expression: 'happy'
            },
            facts: {
                patterns: ['fact', 'interesting', 'tell me something'],
                responses: [
                    "Did you know? Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old!",
                    "Fun fact: Octopuses have three hearts! Two pump blood through the gills, while the third pumps it through the rest of the body.",
                    "Amazing fact: A group of flamingos is called a 'flamboyance'!"
                ],
                expression: 'thinking'
            },
            time: {
                patterns: ['time', 'clock'],
                responses: [
                    `The current time is ${new Date().toLocaleTimeString()}.`,
                    `According to my clock, it's ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}.`
                ],
                expression: 'neutral'
            },
            unknown: {
                responses: [
                    "That's an interesting question! I'm currently using my local knowledge base.",
                    "I'm not sure about that specific topic. Would you like to ask about something else?",
                    "That's beyond my current knowledge. Try asking me about general topics!"
                ],
                expression: 'confused'
            }
        };

        // Initialize App
        function initializeApp() {
            apiKeyInput.value = aiConfig.apiKey;
            aiProviderSelect.value = aiConfig.provider;
            updateAPIKeyPlaceholder();
            updateProviderInfo();
            checkAIStatus();
            updateSystemStatus();
            checkSpeechSupport();
            startEyeTracking();
            startBlinking();
            
            // Show initial message
            addChatMessage("Configure your AI provider above. Groq is recommended - it's free and fast!", "robot");
        }

        // Debug logging
        function debugLog(message, isError = false) {
            console.log(isError ? '‚ùå ' + message : 'üîß ' + message);
            debugInfo.textContent = message;
            debugInfo.className = isError ? 'debug-info' : 'debug-info debug-success';
        }

        // FIXED: Groq API Function with REAL Connection Testing
        async function callGroq(message) {
            debugLog('Calling Groq API...');
            
            if (!aiConfig.apiKey) {
                throw new Error('No Groq API key configured');
            }
            
            if (!aiConfig.apiKey.startsWith('gsk_')) {
                throw new Error('Invalid API key format. Groq keys start with "gsk_"');
            }
            
            try {
                const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${aiConfig.apiKey}`
                    },
                    body: JSON.stringify({
                        model: "llama3-8b-8192",
                        messages: [
                            { 
                                role: "system", 
                                content: "You are a friendly AI assistant. Keep responses concise and under 100 words." 
                            },
                            { role: "user", content: message }
                        ],
                        max_tokens: 150,
                        temperature: 0.7
                    })
                });

                debugLog(`Groq response status: ${response.status}`);

                if (response.status === 401) {
                    // Update status to show it's NOT working
                    aiConfig.actuallyWorking = false;
                    checkAIStatus();
                    throw new Error('Invalid API key. Please check your Groq API key.');
                }

                if (response.status === 429) {
                    throw new Error('Rate limit exceeded. Please try again in a moment.');
                }

                if (!response.ok) {
                    const errorText = await response.text();
                    aiConfig.actuallyWorking = false;
                    checkAIStatus();
                    throw new Error(`API error ${response.status}: ${errorText}`);
                }

                const data = await response.json();
                
                if (data.choices && data.choices[0] && data.choices[0].message) {
                    debugLog('‚úÖ Groq API call successful!');
                    aiConfig.actuallyWorking = true; // Mark as actually working
                    checkAIStatus();
                    return data.choices[0].message.content;
                } else {
                    aiConfig.actuallyWorking = false;
                    checkAIStatus();
                    throw new Error('Unexpected response format from Groq API');
                }

            } catch (error) {
                aiConfig.actuallyWorking = false;
                checkAIStatus();
                debugLog('Groq API error: ' + error.message, true);
                throw error;
            }
        }

        // OpenAI API Function
        async function callOpenAI(message) {
            const messages = [
                { 
                    role: "system", 
                    content: "You are a friendly AI assistant. Keep responses concise." 
                },
                ...conversationHistory.slice(-4)
            ];
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: messages,
                    max_tokens: 150,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                aiConfig.actuallyWorking = false;
                checkAIStatus();
                throw new Error(`OpenAI API error: ${response.status}`);
            }
            
            const data = await response.json();
            aiConfig.actuallyWorking = true;
            checkAIStatus();
            return data.choices[0].message.content;
        }

        // FIXED: Test AI Connection - Actually tests the API
        async function testAIConnection() {
            debugLog('Testing AI connection...');
            
            if (aiConfig.provider === 'local') {
                debugLog('Local AI mode - no connection test needed');
                return;
            }

            if (!aiConfig.apiKey) {
                debugLog('No API key configured', true);
                return;
            }

            setExpression('thinking', 'Testing connection...');

            try {
                let response;
                if (aiConfig.provider === 'groq') {
                    response = await callGroq('Hello! Please respond with "Connection successful"');
                } else if (aiConfig.provider === 'openai') {
                    response = await callOpenAI('Hello! Please respond with "Connection successful"');
                }

                debugLog('‚úÖ Connection test successful! Response: ' + response);
                setExpression('happy', 'Connection good');
                status.textContent = `${aiConfig.provider.toUpperCase()} connection successful!`;
                
                // Add test result to chat
                addChatMessage(`‚úÖ ${aiConfig.provider.toUpperCase()} Connection Test: Successful!`, "robot");
                
            } catch (error) {
                debugLog('Connection test failed: ' + error.message, true);
                setExpression('sad', 'Connection failed');
                status.textContent = `Connection failed: ${error.message}`;
                
                // Add failure to chat
                addChatMessage(`‚ùå ${aiConfig.provider.toUpperCase()} Connection Test Failed: ${error.message}`, "robot");
            }
        }

        // FIXED: System Functions - Now shows actual working status
        function checkAIStatus() {
            const hasValidConfig = aiConfig.provider !== 'local' && aiConfig.apiKey && navigator.onLine;
            aiConfig.enabled = hasValidConfig;
            
            let statusHTML = '';
            let statusText = '';
            
            if (hasValidConfig) {
                if (aiConfig.actuallyWorking) {
                    // API is actually working
                    const statusClass = `status-${aiConfig.provider}`;
                    statusHTML = `<i class="fas fa-wifi ${statusClass}"></i><span>${aiConfig.provider.toUpperCase()}: Online ‚úÖ</span>`;
                    statusText = 'Connected and working';
                } else {
                    // API key exists but not working
                    statusHTML = `<i class="fas fa-wifi status-offline"></i><span>${aiConfig.provider.toUpperCase()}: Error ‚ùå</span>`;
                    statusText = 'API key saved but not working';
                }
            } else if (aiConfig.provider === 'local') {
                statusHTML = '<i class="fas fa-microchip status-local"></i><span>AI: Local Mode</span>';
                statusText = 'Using local AI only';
            } else {
                statusHTML = '<i class="fas fa-microchip status-offline"></i><span>AI: Using Local</span>';
                statusText = 'No valid API configuration';
            }
            
            connectionStatus.innerHTML = statusHTML;
            document.getElementById('current-status').textContent = statusText;
        }

        function updateSystemStatus() {
            document.getElementById('ai-status').textContent = aiConfig.enabled ? aiConfig.provider.toUpperCase() : 'Local';
            document.getElementById('voice-status').textContent = voiceEnabled ? 'Active' : 'Disabled';
        }

        function updateAPIKeyPlaceholder() {
            const placeholders = {
                'openai': 'OpenAI API Key (sk-...)',
                'groq': 'Groq API Key (gsk_...)', 
                'local': 'No API key needed for local AI'
            };
            apiKeyInput.placeholder = placeholders[aiConfig.provider];
            
            if (aiConfig.provider === 'local') {
                apiKeyInput.disabled = true;
                apiKeyInput.value = '';
            } else {
                apiKeyInput.disabled = false;
            }
        }

        function updateProviderInfo() {
            const providerInfoContent = {
                'openai': `
                    <strong>OpenAI:</strong>
                    <ul>
                        <li>‚úÖ Advanced models (GPT-3.5, GPT-4)</li>
                        <li>‚úÖ High quality responses</li>
                        <li>‚ùå Requires billing setup</li>
                        <li>Get API key: <a href="https://platform.openai.com" target="_blank" style="color: #8b5cf6;">platform.openai.com</a></li>
                    </ul>
                `,
                'groq': `
                    <strong>Groq (Recommended):</strong>
                    <ul>
                        <li>‚úÖ Completely free during beta</li>
                        <li>‚úÖ No credit card required</li>
                        <li>‚úÖ Lightning fast responses</li>
                        <li>Get API key: <a href="https://console.groq.com" target="_blank" style="color: #10b981;">console.groq.com</a></li>
                    </ul>
                `,
                'local': `
                    <strong>Local AI:</strong>
                    <ul>
                        <li>‚úÖ Always works offline</li>
                        <li>‚úÖ No API key needed</li>
                        <li>‚úÖ Basic responses only</li>
                        <li>Configure online AI for enhanced capabilities</li>
                    </ul>
                `
            };
            
            document.getElementById('provider-info').innerHTML = providerInfoContent[aiConfig.provider];
        }

        // Expression Management
        function setExpression(expression, message = '', duration = 5000) {
            currentExpression = expression;
            
            humanFace.className = 'human-face';
            if (expression !== 'neutral') {
                humanFace.classList.add(`face-${expression}`);
            }
            
            document.getElementById('current-mood').textContent = expression.charAt(0).toUpperCase() + expression.slice(1);
            document.getElementById('current-status').textContent = message || 'Active';
            
            if (expressionTimeout) clearTimeout(expressionTimeout);
            
            if (expression !== 'neutral') {
                expressionTimeout = setTimeout(() => {
                    setExpression('neutral', 'Ready');
                }, duration);
            }
        }

        // Eye Tracking
        function startEyeTracking() {
            document.addEventListener('mousemove', trackEyes);
        }

        function trackEyes(event) {
            const faceRect = document.querySelector('.face-wrapper').getBoundingClientRect();
            const faceCenterX = faceRect.left + faceRect.width / 2;
            const faceCenterY = faceRect.top + faceRect.height / 2;
            const cursorX = event.clientX;
            const cursorY = event.clientY;
            const deltaX = (cursorX - faceCenterX) / (faceRect.width / 2);
            const deltaY = (cursorY - faceCenterY) / (faceRect.height / 2);
            const maxMovement = 4;
            const moveX = deltaX * maxMovement;
            const moveY = deltaY * maxMovement;
            
            pupilLeft.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
            pupilRight.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
        }

        function startBlinking() {
            const eyes = document.querySelectorAll('.eye');
            
            function blink() {
                eyes.forEach(eye => {
                    eye.style.height = '2px';
                    setTimeout(() => {
                        eye.style.height = '16px';
                    }, 150);
                });
                
                setTimeout(blink, 3000 + Math.random() * 5000);
            }
            
            blink();
        }

        // Chat Functions
        function addChatMessage(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}-message`;
            messageElement.textContent = message;
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        function processInstruction(instruction) {
            instruction = instruction.toLowerCase();
            status.textContent = `Processing: "${instruction}"`;
            setExpression('thinking', 'Processing...');
            
            let matched = false;
            for (const [category, data] of Object.entries(knowledgeBase)) {
                if (data.patterns) {
                    for (const pattern of data.patterns) {
                        if (instruction.includes(pattern)) {
                            matched = true;
                            const response = data.responses[Math.floor(Math.random() * data.responses.length)];
                            setExpression(data.expression, 'Responding...');
                            addChatMessage(response, "robot");
                            status.textContent = 'Ready';
                            setExpression('neutral', 'Ready');
                            break;
                        }
                    }
                    if (matched) break;
                }
            }
            
            if (!matched) {
                if (aiConfig.enabled && aiConfig.actuallyWorking) {
                    // Try AI API
                    sendToAI(instruction);
                } else {
                    const response = knowledgeBase.unknown.responses[Math.floor(Math.random() * knowledgeBase.unknown.responses.length)];
                    addChatMessage(response, "robot");
                    status.textContent = 'Using local AI';
                    setExpression('neutral', 'Ready');
                }
            }
        }

        async function sendToAI(message) {
            if (!aiConfig.enabled || !aiConfig.actuallyWorking) {
                const response = knowledgeBase.unknown.responses[Math.floor(Math.random() * knowledgeBase.unknown.responses.length)];
                addChatMessage(response, "robot");
                return;
            }
            
            try {
                let aiResponse;
                
                if (aiConfig.provider === 'openai') {
                    aiResponse = await callOpenAI(message);
                } else if (aiConfig.provider === 'groq') {
                    aiResponse = await callGroq(message);
                }
                
                addChatMessage(aiResponse, "robot");
                status.textContent = 'Ready';
                setExpression('happy', 'Responded');
                
            } catch (error) {
                debugLog('AI API error: ' + error.message, true);
                const response = knowledgeBase.unknown.responses[Math.floor(Math.random() * knowledgeBase.unknown.responses.length)];
                addChatMessage(response, "robot");
                status.textContent = 'Using local AI due to error';
                setExpression('sad', 'API error');
            }
        }

        function checkSpeechSupport() {
            speechSupported = 'speechSynthesis' in window;
        }

        // Event Listeners
        aiProviderSelect.addEventListener('change', function() {
            aiConfig.provider = this.value;
            aiConfig.actuallyWorking = false; // Reset working status
            updateAPIKeyPlaceholder();
            updateProviderInfo();
            checkAIStatus();
            updateSystemStatus();
        });

        saveApiKeyBtn.addEventListener('click', () => {
            aiConfig.apiKey = apiKeyInput.value.trim();
            aiConfig.actuallyWorking = false; // Reset until we test it
            
            if (aiConfig.provider !== 'local' && aiConfig.apiKey) {
                localStorage.setItem('ai-provider', aiConfig.provider);
                localStorage.setItem('ai-api-key', aiConfig.apiKey);
                status.textContent = `${aiConfig.provider.toUpperCase()} API key saved! Test connection.`;
                setExpression('happy', 'API key saved');
                debugLog('API key saved. Please test connection.');
            } else if (aiConfig.provider === 'local') {
                localStorage.removeItem('ai-provider');
                localStorage.removeItem('ai-api-key');
                status.textContent = 'Using local AI only';
                setExpression('neutral', 'Local AI');
            } else {
                localStorage.removeItem('ai-provider');
                localStorage.removeItem('ai-api-key');
                status.textContent = 'API key removed';
                setExpression('neutral', 'Local AI');
            }
            
            checkAIStatus();
            updateSystemStatus();
        });

        testConnectionBtn.addEventListener('click', testAIConnection);

        executeBtn.addEventListener('click', () => {
            const instruction = instructionInput.value.trim();
            if (instruction) {
                addChatMessage(instruction, "user");
                processInstruction(instruction);
                instructionInput.value = '';
            }
        });

        sendChatBtn.addEventListener('click', () => {
            const message = chatInput.value.trim();
            if (message) {
                addChatMessage(message, "user");
                processInstruction(message);
                chatInput.value = '';
            }
        });

        clearChatBtn.addEventListener('click', () => {
            chatMessages.innerHTML = '';
            addChatMessage("Conversation cleared. Let's start fresh!", "robot");
        });

        commandBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const command = btn.getAttribute('data-command');
                addChatMessage(command, "user");
                processInstruction(command);
            });
        });

        // Initialize the app
        initializeApp();
async function callGroq() {
    const apiKey = "YOUR_GROQ_API_KEY";

    const response = await fetch("https://api.groq.com/openai/v1/responses", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${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}`
        },
        body: JSON.stringify({
            model: "openai/gpt-oss-20b",
            input: "Explain the importance of fast language models"
        })
    });

    const data = await response.json();
    console.log(data.output_text);
}

callGroq();
    </script>
</body>
</html>