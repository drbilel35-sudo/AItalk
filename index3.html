<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant - Real-time Voice & Expressions</title>
    <meta name="description" content="Real-time conversational AI with animated face and voice interaction">
    <meta name="theme-color" content="#4a6fa5">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AI Assistant">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #4a6fa5);
            color: white;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            cursor: default;
            overflow-x: hidden;
        }

        /* App Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(26, 42, 108, 0.95);
            backdrop-filter: blur(10px);
            padding: 15px 20px;
            z-index: 1000;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .logo-header {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .logo {
            width: 40px;
            height: 40px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .header-text {
            text-align: left;
        }

        .app-title {
            font-size: 1.3rem;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
            background: linear-gradient(45deg, #fff, #a8d8ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
        }

        .connection-status {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 0.75rem;
            background: rgba(255, 255, 255, 0.1);
        }

        .status-online {
            color: #4ade80;
        }

        .status-offline {
            color: #f87171;
        }

        .status-groq {
            color: #10b981 !important;
        }

        .status-openai {
            color: #8b5cf6 !important;
        }

        .status-local {
            color: #f59e0b !important;
        }

        /* Language Selector */
        .language-selector {
            position: relative;
        }
        
        .language-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .language-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: rgba(26, 42, 108, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 8px;
            padding: 8px;
            margin-top: 5px;
            display: none;
            min-width: 150px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 1001;
        }
        
        .language-dropdown.show {
            display: block;
        }
        
        .language-option {
            padding: 8px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .language-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .language-option.active {
            background: rgba(74, 111, 165, 0.5);
        }
        
        .language-flag {
            width: 20px;
            height: 15px;
            border-radius: 2px;
        }
        
        .language-name {
            flex: 1;
        }
        
        .language-check {
            color: #4ade80;
        }

        /* Main App Layout */
        .app-container {
            display: flex;
            flex: 1;
            margin-top: 70px; /* Account for fixed header */
            height: calc(100vh - 70px);
        }

        /* Fixed Face Section */
        .face-section {
            position: fixed;
            left: 0;
            top: 70px;
            width: 350px;
            height: calc(100vh - 70px);
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 900;
            overflow-y: auto;
            /* Ensure it stays fixed while scrolling */
            position: -webkit-sticky; /* For Safari */
            position: sticky;
        }

        .face-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-bottom: 20px;
        }

        .face-wrapper {
            position: relative;
            width: 280px;
            height: 280px;
        }

        .human-face {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 4px solid rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            object-fit: cover;
        }

        /* Eye Tracking System */
        .eye-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        .eye {
            position: absolute;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            overflow: hidden;
            box-shadow: 0 0 3px rgba(0,0,0,0.25);
        }

        .eye-left {
            top: 28%;
            left: 39.4%;
        }

        .eye-right {
            top: 28%;
            left: 54.1%;
        }

        .pupil {
            position: absolute;
            width: 10px;
            height: 10px;
            background: #1a2a6c;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            transition: transform 0.12s ease-out;
            box-shadow: 0 0 2px rgba(0,0,0,0.5);
        }

        /* Mouth */
        .mouth {
            position: absolute;
            top: 44.5%;
            left: 46%;
            transform: translateX(-50%);
            width: 20px;
            height: 10px;
            background: #ff6b8b;
            border-radius: 50%;
            display: none;
            z-index: 6;
            box-shadow: 0 0 4px rgba(0,0,0,0.3);
        }

        .face-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
            mix-blend-mode: overlay;
            z-index: 2;
        }

        .face-overlay.active {
            opacity: 0.6;
        }

        .face-status {
            position: absolute;
            bottom: 15px;
            left: 0;
            right: 0;
            text-align: center;
            background: rgba(0, 0, 0, 0.7);
            padding: 8px;
            border-radius: 8px;
            margin: 0 15px;
            z-index: 3;
            font-size: 0.8rem;
        }

        .expression-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            gap: 4px;
            z-index: 3;
        }

        .robot-info {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(0, 0, 0, 0.7);
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 0.7rem;
            z-index: 3;
        }

        /* Controls Panel */
        .controls-panel {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 12px;
            padding: 15px;
        }

        .instruction-input {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        input, select {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.9);
            font-size: 0.9rem;
            outline: none;
            color: #333;
        }

        button {
            padding: 10px 15px;
            background: #4a6fa5;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        button:hover {
            background: #5a7fb5;
            transform: translateY(-1px);
        }

        button:active {
            transform: translateY(1px);
        }

        .voice-btn {
            background: #ff6b6b;
            width: 100%;
            justify-content: center;
            margin-top: 8px;
        }

        .voice-btn:hover {
            background: #ff7b7b;
        }

        .status {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 0.85rem;
        }

        .commands {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            margin-top: 12px;
        }

        .command-btn {
            padding: 8px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 0.8rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .command-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.03);
        }

        /* Scrollable Content Section */
        .content-section {
            margin-left: 350px;
            flex: 1;
            display: flex;
            flex-direction: column;
            height: calc(100vh - 70px);
            padding: 20px;
            overflow-y: auto;
            /* Ensure content scrolls independently */
            position: relative;
            z-index: 800;
        }

        .chat-container {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            margin-bottom: 15px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 8px;
            margin-bottom: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .message {
            padding: 10px 12px;
            border-radius: 12px;
            max-width: 85%;
            word-wrap: break-word;
            font-size: 0.9rem;
            animation: messageAppear 0.3s ease-out;
        }

        @keyframes messageAppear {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .user-message {
            background: rgba(74, 111, 165, 0.7);
            align-self: flex-end;
            border-bottom-right-radius: 5px;
        }

        .robot-message {
            background: rgba(255, 255, 255, 0.2);
            align-self: flex-start;
            border-bottom-left-radius: 5px;
        }

        .chat-input {
            display: flex;
            gap: 8px;
        }

        .chat-input input {
            flex: 1;
        }

        .conversation-controls {
            display: flex;
            gap: 8px;
            margin-top: 10px;
        }

        .conversation-btn {
            flex: 1;
            padding: 8px;
            font-size: 0.8rem;
        }

        .api-key-section {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .api-key-input {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .api-key-input input {
            flex: 1;
        }

        .voice-test {
            margin-top: 10px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            text-align: center;
        }

        .voice-test-btn {
            width: 100%;
            margin-top: 5px;
        }

        /* Hide features section for professional look */
        .instructions {
            display: none;
        }

        /* Voice status styles */
        .voice-status {
            padding: 8px 12px;
            border-radius: 8px;
            margin: 5px 0;
            font-size: 0.8rem;
            text-align: center;
        }
        
        .voice-listening {
            background: rgba(76, 175, 80, 0.3);
            border-left: 3px solid #4ade80;
            animation: pulse 1.5s infinite;
        }
        
        .voice-error {
            background: rgba(244, 67, 54, 0.3);
            border-left: 3px solid #f44336;
        }
        
        .voice-ready {
            background: rgba(33, 150, 243, 0.3);
            border-left: 3px solid #2196F3;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }

        .typing-indicator {
            display: inline-block;
            position: relative;
            width: 50px;
            height: 18px;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: white;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .fallback-notice {
            background: rgba(255, 193, 7, 0.2);
            border-left: 3px solid #ffc107;
            padding: 8px 12px;
            margin: 8px 0;
            border-radius: 0 6px 6px 0;
            font-size: 0.8rem;
        }

        /* Expression animations */
        .face-happy {
            filter: brightness(1.1) saturate(1.2);
            transform: scale(1.05);
        }

        .face-sad {
            filter: brightness(0.9) saturate(0.8);
            transform: scale(0.95);
        }

        .face-thinking {
            filter: brightness(1) contrast(1.1);
            animation: thinking 2s infinite;
        }

        .face-talking {
            animation: talk 0.5s infinite alternate;
        }

        .face-excited {
            filter: brightness(1.2) saturate(1.3);
            animation: excited 1.5s infinite alternate;
        }

        .face-confused {
            filter: brightness(0.95) contrast(1.1);
            animation: confused 2s infinite;
        }

        .face-surprised {
            filter: brightness(1.1) saturate(1.1);
            animation: surprised 0.8s ease-in-out;
        }

        @keyframes thinking {
            0%, 100% { transform: rotate(0deg); }
            25% { transform: rotate(1deg); }
            75% { transform: rotate(-1deg); }
        }

        @keyframes talk {
            0% { transform: scale(1); }
            100% { transform: scale(1.02); }
        }

        @keyframes excited {
            0% { transform: scale(1); }
            100% { transform: scale(1.05); }
        }

        @keyframes confused {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-3px); }
            75% { transform: translateX(3px); }
        }

        @keyframes surprised {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Lip sync animation */
        @keyframes lip-sync {
            0%, 100% { transform: scaleY(1); }
            50% { transform: scaleY(0.3); }
        }

        .mouth.talking {
            display: block;
            animation: lip-sync 0.2s infinite alternate;
        }

        /* RTL support for Urdu */
        .rtl {
            direction: rtl;
            text-align: right;
        }
        
        .rtl .message {
            text-align: right;
        }
        
        .rtl .command-btn {
            text-align: center;
        }
        
        .rtl .header-text {
            text-align: right;
        }
        
        .rtl .face-status {
            text-align: center;
        }
        
        .rtl .expression-indicator {
            left: 15px;
            right: auto;
        }
        
        .rtl .robot-info {
            right: 15px;
            left: auto;
        }
        
        .rtl .instruction-input {
            flex-direction: row-reverse;
        }
        
        .rtl .api-key-input {
            flex-direction: row-reverse;
        }
        
        .rtl .chat-input {
            flex-direction: row-reverse;
        }
        
        .rtl .conversation-controls {
            flex-direction: row-reverse;
        }
        
        .rtl .provider-info ul {
            margin: 5px 15px 0 0;
        }

        /* Mobile Responsive */
        @media (max-width: 1024px) {
            .face-section {
                width: 300px;
            }
            
            .content-section {
                margin-left: 300px;
            }
            
            .face-wrapper {
                width: 240px;
                height: 240px;
            }
        }

        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .face-section {
                position: relative;
                width: 100%;
                height: auto;
                top: 0;
                /* Remove fixed positioning on mobile */
                position: relative;
            }
            
            .content-section {
                margin-left: 0;
                height: auto;
            }
            
            .app-header {
                padding: 10px 15px;
            }
            
            .app-container {
                margin-top: 60px;
                height: auto;
            }
        }

        .provider-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 8px;
            margin-top: 8px;
            font-size: 0.8rem;
        }

        .provider-info ul {
            margin: 5px 0 0 15px;
        }

        .provider-info li {
            margin-bottom: 3px;
        }
    </style>
</head>
<body>
    <!-- Fixed App Header -->
    <header class="app-header">
        <div class="logo-header">
            <!-- AI Assistant Logo -->
            <svg class="logo" viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
                <defs>
                    <linearGradient id="faceGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" stop-color="#667eea" />
                        <stop offset="100%" stop-color="#764ba2" />
                    </linearGradient>
                    <radialGradient id="eyeGradient" cx="50%" cy="50%" r="50%">
                        <stop offset="0%" stop-color="#ffffff" />
                        <stop offset="100%" stop-color="#f0f8ff" />
                    </radialGradient>
                    <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
                        <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur" />
                        <feMerge> 
                            <feMergeNode in="blur"/>
                            <feMergeNode in="SourceGraphic"/>
                        </feMerge>
                    </filter>
                </defs>
                
                <!-- Main Face Circle -->
                <circle cx="100" cy="100" r="80" fill="url(#faceGradient)" stroke="#fff" stroke-width="2" filter="url(#glow)"/>
                
                <!-- Eyes -->
                <ellipse cx="75" cy="85" rx="12" ry="15" fill="url(#eyeGradient)"/>
                <ellipse cx="125" cy="85" rx="12" ry="15" fill="url(#eyeGradient)"/>
                
                <!-- Pupils with Animation Effect -->
                <circle cx="75" cy="85" r="6" fill="#1a2a6c">
                    <animate attributeName="cy" values="85;83;85" dur="2s" repeatCount="indefinite"/>
                </circle>
                <circle cx="125" cy="85" r="6" fill="#1a2a6c">
                    <animate attributeName="cy" values="85;83;85" dur="2s" repeatCount="indefinite"/>
                </circle>
                
                <!-- Smiling Mouth -->
                <path d="M70 120 Q100 140 130 120" stroke="#ff6b8b" stroke-width="6" stroke-linecap="round" fill="none">
                    <animate attributeName="d" values="M70 120 Q100 140 130 120; M70 120 Q100 130 130 120; M70 120 Q100 140 130 120" 
                             dur="3s" repeatCount="indefinite"/>
                </path>
                
                <!-- Voice/Sound Waves -->
                <g opacity="0.8">
                    <path d="M160 70 Q170 70 170 80 Q170 90 160 90" stroke="#4ade80" stroke-width="3" fill="none"/>
                    <path d="M165 60 Q180 60 180 75 Q180 90 165 90" stroke="#4ade80" stroke-width="3" fill="none"/>
                    <path d="M170 50 Q190 50 190 75 Q190 100 170 100" stroke="#4ade80" stroke-width="3" fill="none"/>
                </g>
                
                <!-- AI Circuit Pattern -->
                <g stroke="#fff" stroke-width="1.5" opacity="0.7">
                    <path d="M50 60 L60 60 L60 50" fill="none"/>
                    <path d="M40 70 L50 70 L50 80" fill="none"/>
                    <circle cx="55" cy="65" r="2" fill="#4ade80"/>
                    <path d="M150 60 L140 60 L140 50" fill="none"/>
                    <path d="M160 70 L150 70 L150 80" fill="none"/>
                    <circle cx="145" cy="65" r="2" fill="#ff6b6b"/>
                </g>
                
                <!-- Sparkle Elements -->
                <g fill="#ffd700" opacity="0.9">
                    <path d="M100 40 L102 45 L107 45 L103 48 L105 53 L100 50 L95 53 L97 48 L93 45 L98 45 Z">
                        <animateTransform attributeName="transform" type="rotate" from="0 100 40" to="360 100 40" dur="4s" repeatCount="indefinite"/>
                    </path>
                    <path d="M40 100 L45 102 L45 107 L48 103 L53 105 L50 100 L53 95 L48 97 L45 93 L45 98 Z" opacity="0.7"/>
                    <path d="M160 100 L155 102 L155 107 L152 103 L147 105 L150 100 L147 95 L152 97 L155 93 L155 98 Z" opacity="0.7"/>
                </g>
            </svg>
            
            <div class="header-text">
                <h1 class="app-title" id="app-title">AI Assistant</h1>
            </div>
        </div>
        
        <div class="connection-status" id="connection-status">
            <i class="fas fa-microchip status-local"></i>
            <span id="connection-text">AI: Local Mode</span>
        </div>
        
        <!-- Language Selector -->
        <div class="language-selector">
            <div class="language-btn" id="language-btn">
                <i class="fas fa-globe"></i>
                <span id="current-language">English</span>
                <i class="fas fa-chevron-down"></i>
            </div>
            <div class="language-dropdown" id="language-dropdown">
                <div class="language-option" data-lang="en">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2MCAzMCI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjMDEyMTY5Ii8+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYiIGZpbGw9IiNjODEwMmUiLz48cmVjdCB4PSIwIiB5PSI2IiB3aWR0aD0iNiIgaGVpZ2h0PSI2IiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iMCIgeT0iMTIiIHdpZHRoPSI2MCIgaGVpZ2h0PSI2IiBmaWxsPSIjYzgxMDJlIi8+PHJlY3QgeD0iMCIgeT0iMTgiIHdpZHRoPSI2IiBoZWlnaHQ9IjYiIGZpbGw9IiNmZmYiLz48cmVjdCB4PSIwIiB5PSIyNCIgd2lkdGg9IjYwIiBoZWlnaHQ9IjYiIGZpbGw9IiNjODEwMmUiLz48L3N2Zz4=" class="language-flag" alt="English">
                    <span class="language-name">English</span>
                    <i class="fas fa-check language-check" style="display: none;"></i>
                </div>
                <div class="language-option" data-lang="vi">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2MCAzMCI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjZGEyNTE0Ii8+PHBvbHlnb24gcG9pbnRzPSIzMCwxNSA0MCwyMCAzMCwyNSIgZmlsbD0iI2ZmZiIvPjxzdGFyIHBvaW50cz0iMzAsMTAgMjUsMTggMzUsMTgiIGZpbGw9IiNmZmYiLz48L3N2Zz4=" class="language-flag" alt="Vietnamese">
                    <span class="language-name">Tiếng Việt</span>
                    <i class="fas fa-check language-check" style="display: none;"></i>
                </div>
                <div class="language-option" data-lang="ur">
                    <img src="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA2MCAzMCI+PHJlY3Qgd2lkdGg9IjYwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjMDA3MDAwIi8+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjIwIiBoZWlnaHQ9IjMwIiBmaWxsPSIjZmZmIi8+PHJlY3QgeD0iNDAiIHk9IjAiIHdpZHRoPSIyMCIgaGVpZ2h0PSIzMCIgZmlsbD0iI2ZmZiIvPjxjaXJjbGUgY3g9IjMwIiBjeT0iMTUiIHI9IjYiIGZpbGw9IiNmZmYiLz48Y2lyY2xlIGN4PSIzMCIgY3k9IjE1IiByPSI0IiBmaWxsPSIjMDA3MDAwIi8+PHBvbHlnb24gcG9pbnRzPSIzMCwxMCAyOCwxOCAzMiwxOCIgZmlsbD0iIzAwNzAwMCIvPjwvc3ZnPg==" class="language-flag" alt="Urdu">
                    <span class="language-name">اردو</span>
                    <i class="fas fa-check language-check" style="display: none;"></i>
                </div>
            </div>
        </div>
    </header>

    <!-- Main App Container -->
    <div class="app-container">
        <!-- Fixed Left Panel with Face -->
        <div class="face-section">
            <div class="face-container">
                <div class="face-wrapper">
                    <!-- Base face -->
                    <img src="https://i.postimg.cc/jqgvh4sg/IMG-20251123-WA0008.jpg" 
                         alt="AI Assistant" class="human-face" id="human-face">
                    
                    <!-- Eye Tracking System -->
                    <div class="eye-container">
                        <div class="eye eye-left">
                            <div class="pupil" id="pupil-left"></div>
                        </div>
                        <div class="eye eye-right">
                            <div class="pupil" id="pupil-right"></div>
                        </div>
                    </div>
                    
                    <!-- Expression overlays -->
                    <div class="face-overlay" id="happy-overlay" style="background: linear-gradient(45deg, rgba(255,255,0,0.3), rgba(255,165,0,0.3));"></div>
                    <div class="face-overlay" id="sad-overlay" style="background: linear-gradient(45deg, rgba(0,0,255,0.3), rgba(128,0,128,0.3));"></div>
                    <div class="face-overlay" id="thinking-overlay" style="background: linear-gradient(45deg, rgba(128,0,128,0.3), rgba(75,0,130,0.3));"></div>
                    <div class="face-overlay" id="excited-overlay" style="background: linear-gradient(45deg, rgba(255,0,0,0.3), rgba(255,165,0,0.3));"></div>
                    
                    <!-- Lip sync element -->
                    <div class="mouth" id="mouth"></div>

                    <!-- Status Indicators -->
                    <div class="expression-indicator" id="expression-indicator">
                        <i class="fas fa-smile" id="expression-icon"></i>
                        <span id="expression-text">Ready</span>
                    </div>
                    
                    <div class="robot-info" id="robot-info">
                        <div>AI: <span id="ai-status">Local</span></div>
                        <div id="voice-status-text">Voice: <span id="voice-status">Ready</span></div>
                    </div>
                    
                    <div class="face-status" id="face-status">
                        <div id="status-text">Status: <span id="current-status">Online</span></div>
                        <div id="mood-text">Mood: <span id="current-mood">Neutral</span></div>
                    </div>
                </div>
            </div>

            <!-- Controls Panel -->
            <div class="controls-panel">
                <div class="instruction-input">
                    <input type="text" id="instruction-input" placeholder="Ask me anything...">
                    <button id="execute-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
                
                <button id="voice-btn" class="voice-btn"><i class="fas fa-microphone"></i> <span id="voice-btn-text">Voice Command</span></button>
                
                <div class="status" id="status">Ready to assist you!</div>
                
                <div class="commands">
                    <div class="command-btn" data-command="greet">
                        <i class="fas fa-hand-wave"></i>
                        <span id="greet-text">Greet</span>
                    </div>
                    <div class="command-btn" data-command="joke">
                        <i class="fas fa-laugh"></i>
                        <span id="joke-text">Joke</span>
                    </div>
                    <div class="command-btn" data-command="fact">
                        <i class="fas fa-lightbulb"></i>
                        <span id="fact-text">Fact</span>
                    </div>
                    <div class="command-btn" data-command="time">
                        <i class="fas fa-clock"></i>
                        <span id="time-text">Time</span>
                    </div>
                    <div class="command-btn" data-command="calculate">
                        <i class="fas fa-calculator"></i>
                        <span id="calculate-text">Calculate</span>
                    </div>
                    <div class="command-btn" data-command="weather">
                        <i class="fas fa-cloud-sun"></i>
                        <span id="weather-text">Weather</span>
                    </div>
                    <div class="command-btn" data-command="news">
                        <i class="fas fa-newspaper"></i>
                        <span id="news-text">News</span>
                    </div>
                    <div class="command-btn" data-command="introduce">
                        <i class="fas fa-robot"></i>
                        <span id="introduce-text">Introduce</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Scrollable Right Content -->
        <div class="content-section">
            <!-- Chat Container -->
            <div class="chat-container">
                <div class="chat-messages" id="chat-messages">
                    <div class="message robot-message">
                        <span id="welcome-message">Hello! I'm your AI assistant. Choose your preferred AI provider below for enhanced capabilities!</span>
                        <div class="fallback-notice">
                            <i class="fas fa-info-circle"></i> <span id="groq-notice">Groq API is free and super fast - recommended for testing!</span>
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <input type="text" id="chat-input" placeholder="Type your message here...">
                    <button id="send-chat-btn"><i class="fas fa-paper-plane"></i></button>
                </div>
                <div class="conversation-controls">
                    <button id="clear-chat-btn" class="conversation-btn"><i class="fas fa-trash"></i> <span id="clear-chat-text">Clear Chat</span></button>
                    <button id="auto-chat-btn" class="conversation-btn"><i class="fas fa-robot"></i> <span id="auto-chat-text">Auto Chat</span></button>
                </div>
            </div>

            <!-- Configuration Section -->
            <div class="api-key-section">
                <h3><i class="fas fa-key"></i> <span id="config-title">AI Configuration</span></h3>
                
                <!-- AI Provider Selection -->
                <div class="provider-selection" style="margin-bottom: 15px;">
                    <label id="provider-label">AI Provider:</label>
                    <select id="ai-provider" style="width: 100%; padding: 8px; border-radius: 6px; margin-top: 5px; background: rgba(255,255,255,0.9); color: #333;">
                        <option value="local" id="local-option">Local AI Only</option>
                        <option value="groq" id="groq-option">Groq (Llama 3 - Free & Fast)</option>
                        <option value="openai" id="openai-option">OpenAI (GPT-3.5/4)</option>
                    </select>
                </div>
                
                <!-- Provider Information -->
                <div class="provider-info" id="provider-info">
                    <strong id="groq-title">Groq (Recommended):</strong>
                    <ul>
                        <li id="groq-point1">✅ Completely free during beta</li>
                        <li id="groq-point2">✅ No credit card required</li>
                        <li id="groq-point3">✅ Lightning fast responses</li>
                        <li id="groq-link">Get API key: <a href="https://console.groq.com" target="_blank" style="color: #4ade80;">console.groq.com</a></li>
                    </ul>
                </div>
                
                <!-- API Key Input -->
                <div id="api-key-fields" style="margin-top: 15px;">
                    <div class="api-key-input">
                        <input type="password" id="api-key-input" placeholder="No API key needed for local AI">
                        <button id="save-api-key-btn"><i class="fas fa-save"></i> <span id="save-text">Save</span></button>
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 8px;">
                    <button id="enable-voice-btn" class="voice-btn"><i class="fas fa-microphone-alt"></i> <span id="enable-voice-text">Enable Voice</span></button>
                    <button id="continuous-mode-btn" class="voice-btn"><i class="fas fa-comments"></i> <span id="continuous-mode-text">Continuous Mode</span></button>
                </div>
                
                <div class="voice-test">
                    <p><strong id="voice-test-title">Voice Test:</strong> <span id="voice-test-desc">Check if speech synthesis works</span></p>
                    <button id="test-voice-btn" class="voice-test-btn voice-btn">
                        <i class="fas fa-volume-up"></i> <span id="test-voice-text">Test Voice</span>
                    </button>
                    <div id="voice-debug" style="margin-top: 8px; font-size: 0.8rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Language configuration
        const languages = {
            en: {
                name: "English",
                direction: "ltr",
                // UI Texts
                appTitle: "AI Assistant",
                connectionText: "AI: Local Mode",
                statusText: "Status:",
                moodText: "Mood:",
                voiceStatusText: "Voice:",
                instructionPlaceholder: "Ask me anything...",
                voiceBtnText: "Voice Command",
                greetText: "Greet",
                jokeText: "Joke",
                factText: "Fact",
                timeText: "Time",
                calculateText: "Calculate",
                weatherText: "Weather",
                newsText: "News",
                introduceText: "Introduce",
                welcomeMessage: "Hello! I'm your AI assistant. Choose your preferred AI provider below for enhanced capabilities!",
                groqNotice: "Groq API is free and super fast - recommended for testing!",
                chatPlaceholder: "Type your message here...",
                clearChatText: "Clear Chat",
                autoChatText: "Auto Chat",
                configTitle: "AI Configuration",
                providerLabel: "AI Provider:",
                localOption: "Local AI Only",
                groqOption: "Groq (Llama 3 - Free & Fast)",
                openaiOption: "OpenAI (GPT-3.5/4)",
                groqTitle: "Groq (Recommended):",
                groqPoint1: "✅ Completely free during beta",
                groqPoint2: "✅ No credit card required",
                groqPoint3: "✅ Lightning fast responses",
                groqLink: "Get API key:",
                apiKeyPlaceholder: "No API key needed for local AI",
                saveText: "Save",
                enableVoiceText: "Enable Voice",
                continuousModeText: "Continuous Mode",
                voiceTestTitle: "Voice Test:",
                voiceTestDesc: "Check if speech synthesis works",
                testVoiceText: "Test Voice",
                // Status Messages
                readyStatus: "Ready to assist you!",
                listeningStatus: "Listening... Speak now!",
                voiceReadyStatus: "Voice ready - Click to speak again",
                processingStatus: "Processing...",
                speakingStatus: "Speaking...",
                // Expressions
                readyExpression: "Ready",
                listeningExpression: "Listening to you...",
                processingExpression: "Processing...",
                respondingExpression: "Responding...",
                voiceErrorExpression: "Voice error",
                providerChangedExpression: "Provider changed",
                apiKeySavedExpression: "API key saved",
                localAIExpression: "Local AI",
                autoChatActiveExpression: "Auto chat active",
                // Knowledge Base
                knowledgeBase: {
                    greetings: {
                        patterns: ['hello', 'hi', 'hey', 'greetings', 'good morning', 'good afternoon', 'good evening'],
                        responses: [
                            "Hello! I'm your AI assistant. How can I help you today?",
                            "Hi there! I'm ready to assist you with anything you need.",
                            "Greetings! I'm your AI companion here to help you.",
                            "Hello! I can see you're ready to interact. What would you like to do?"
                        ],
                        expression: 'happy'
                    },
                    capabilities: {
                        patterns: ['what can you do', 'capabilities', 'features', 'help'],
                        responses: [
                            "I'm a complete AI assistant! I can chat with you, understand voice commands, perform calculations, provide information, tell jokes, and much more!",
                            "As your AI assistant, I offer intelligent conversations, voice recognition, task automation, and various utility functions.",
                            "I'm equipped with speech synthesis, AI-powered conversations, and various functions to help you daily."
                        ],
                        expression: 'excited'
                    },
                    jokes: {
                        patterns: ['joke', 'funny', 'laugh', 'humor'],
                        responses: [
                            "Why don't scientists trust atoms? Because they make up everything!",
                            "Why did the scarecrow win an award? He was outstanding in his field!",
                            "What do you call a fake noodle? An impasta!",
                            "Why did the math book look so sad? Because it had too many problems!",
                            "Why don't skeletons fight each other? They don't have the guts!"
                        ],
                        expression: 'happy'
                    },
                    facts: {
                        patterns: ['fact', 'interesting', 'tell me something', 'did you know'],
                        responses: [
                            "Did you know? The shortest war in history was between Britain and Zanzibar in 1896. It lasted only 38 minutes!",
                            "Interesting fact: Honey never spoils. Archaeologists have found pots of honey in ancient Egyptian tombs that are over 3,000 years old!",
                            "Fun fact: Octopuses have three hearts! Two pump blood through the gills, while the third pumps it through the rest of the body.",
                            "Did you know? Bananas are berries, but strawberries aren't!",
                            "Amazing fact: A group of flamingos is called a 'flamboyance'!"
                        ],
                        expression: 'thinking'
                    },
                    time: {
                        patterns: ['time', 'clock', 'what time', 'current time'],
                        responses: [
                            `The current time is ${new Date().toLocaleTimeString()}.`,
                            `According to my clock, it's ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}.`,
                            `It's ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} right now.`
                        ],
                        expression: 'neutral'
                    },
                    weather: {
                        patterns: ['weather', 'temperature', 'forecast', 'how is the weather'],
                        getWeather: async function() {
                            try {
                                // Simulated weather based on season and time
                                const now = new Date();
                                const month = now.getMonth();
                                const hour = now.getHours();
                                
                                // Seasonal weather patterns
                                let season, baseTemp, conditions;
                                
                                if (month >= 2 && month <= 4) { // Spring
                                    season = "spring";
                                    baseTemp = 15;
                                    conditions = ["sunny with mild breezes", "partly cloudy", "light showers"];
                                } else if (month >= 5 && month <= 7) { // Summer
                                    season = "summer";
                                    baseTemp = 25;
                                    conditions = ["sunny and warm", "clear skies", "partly cloudy"];
                                } else if (month >= 8 && month <= 10) { // Autumn
                                    season = "autumn";
                                    baseTemp = 18;
                                    conditions = ["crisp and clear", "breezy", "light rain"];
                                } else { // Winter
                                    season = "winter";
                                    baseTemp = 5;
                                    conditions = ["cold and clear", "overcast", "light snow"];
                                }
                                
                                // Time of day adjustments
                                if (hour >= 22 || hour < 6) { // Night
                                    baseTemp -= 5;
                                    conditions = ["clear night", "partly cloudy", "cool and calm"];
                                } else if (hour >= 6 && hour < 12) { // Morning
                                    baseTemp += 2;
                                } else if (hour >= 12 && hour < 18) { // Afternoon
                                    baseTemp += 5;
                                }
                                
                                // Add some random variation
                                const tempVariation = Math.floor(Math.random() * 8) - 4;
                                const finalTemp = baseTemp + tempVariation;
                                const condition = conditions[Math.floor(Math.random() * conditions.length)];
                                
                                return `Current simulated weather: ${finalTemp}°C with ${condition}. Based on ${season} season and time of day.`;
                            } catch (error) {
                                console.error('Weather error:', error);
                                return "I'm having trouble accessing weather data right now. Please try again later or check a weather service online.";
                            }
                        },
                        expression: 'neutral'
                    },
                    math: {
                        patterns: ['calculate', 'math', 'equation'],
                        calculate: function(question) {
                            const mathRegex = /(\d+)\s*(plus|\+|\-|minus|times|\*|multiplied by|divided by|\/)\s*(\d+)/i;
                            const match = question.match(mathRegex);
                            
                            if (match) {
                                const num1 = parseInt(match[1]);
                                const num2 = parseInt(match[3]);
                                const operation = match[2].toLowerCase();
                                
                                let result;
                                switch(operation) {
                                    case 'plus': case '+': 
                                        result = num1 + num2;
                                        return `The answer is ${num1} + ${num2} = ${result}`;
                                    case 'minus': case '-':
                                        result = num1 - num2;
                                        return `The answer is ${num1} - ${num2} = ${result}`;
                                    case 'times': case '*': case 'multiplied by':
                                        result = num1 * num2;
                                        return `The answer is ${num1} × ${num2} = ${result}`;
                                    case 'divided by': case '/':
                                        if (num2 === 0) return "I can't divide by zero!";
                                        result = num1 / num2;
                                        return `The answer is ${num1} ÷ ${num2} = ${result}`;
                                }
                            }
                            return "I can help with calculations! Try something like 'calculate 15 plus 27'";
                        },
                        expression: 'thinking'
                    },
                    conversation: {
                        patterns: ['how are you', 'how do you feel', 'what do you think'],
                        responses: [
                            "I'm doing great! Thanks for asking. I love having conversations with you.",
                            "I'm feeling wonderful! Every interaction helps me learn and improve.",
                            "I'm excited to be chatting with you! What's on your mind today?",
                            "I'm doing well, thank you! I enjoy our conversations."
                        ],
                        expression: 'happy'
                    },
                    introduce: {
                        patterns: ['introduce', 'who are you', 'what are you'],
                        responses: [
                            "I'm your AI assistant, a fully functional conversational AI with animated expressions and voice capabilities!",
                            "I'm a real-time AI assistant designed to help you with various tasks and have engaging conversations.",
                            "I'm an advanced AI assistant with eye tracking, facial expressions, and voice interaction capabilities."
                        ],
                        expression: 'excited'
                    },
                    news: {
                        patterns: ['news', 'headlines', 'latest'],
                        responses: [
                            "I don't have real-time news access in my current mode, but I can discuss general topics with you!",
                            "For the latest news, I'd recommend checking a news website. I'm better at conversations and calculations!",
                            "I specialize in interactive conversations rather than news updates. What else can I help you with?"
                        ],
                        expression: 'neutral'
                    },
                    unknown: {
                        responses: [
                            "That's an interesting question! I'm currently using my local knowledge base.",
                            "I'm not sure about that specific topic in my current mode. Would you like to ask about something else?",
                            "That's beyond my current knowledge. I specialize in conversations, calculations, and general assistance.",
                            "I don't have information about that right now. Try asking me about general topics or enable online AI for more capabilities!"
                        ],
                        expression: 'confused'
                    }
                }
            },
            vi: {
                name: "Tiếng Việt",
                direction: "ltr",
                // UI Texts
                appTitle: "Trợ lý AI",
                connectionText: "AI: Chế độ cục bộ",
                statusText: "Trạng thái:",
                moodText: "Tâm trạng:",
                voiceStatusText: "Giọng nói:",
                instructionPlaceholder: "Hỏi tôi bất cứ điều gì...",
                voiceBtnText: "Lệnh thoại",
                greetText: "Chào hỏi",
                jokeText: "Câu đùa",
                factText: "Sự thật",
                timeText: "Thời gian",
                calculateText: "Tính toán",
                weatherText: "Thời tiết",
                newsText: "Tin tức",
                introduceText: "Giới thiệu",
                welcomeMessage: "Xin chào! Tôi là trợ lý AI của bạn. Chọn nhà cung cấp AI ưa thích của bạn bên dưới để có các tính năng nâng cao!",
                groqNotice: "API Groq miễn phí và siêu nhanh - được khuyến nghị để thử nghiệm!",
                chatPlaceholder: "Nhập tin nhắn của bạn ở đây...",
                clearChatText: "Xóa trò chuyện",
                autoChatText: "Trò chuyện tự động",
                configTitle: "Cấu hình AI",
                providerLabel: "Nhà cung cấp AI:",
                localOption: "Chỉ AI cục bộ",
                groqOption: "Groq (Llama 3 - Miễn phí & Nhanh)",
                openaiOption: "OpenAI (GPT-3.5/4)",
                groqTitle: "Groq (Được khuyến nghị):",
                groqPoint1: "✅ Hoàn toàn miễn phí trong thời gian beta",
                groqPoint2: "✅ Không cần thẻ tín dụng",
                groqPoint3: "✅ Phản hồi cực nhanh",
                groqLink: "Nhận khóa API:",
                apiKeyPlaceholder: "Không cần khóa API cho AI cục bộ",
                saveText: "Lưu",
                enableVoiceText: "Bật giọng nói",
                continuousModeText: "Chế độ liên tục",
                voiceTestTitle: "Kiểm tra giọng nói:",
                voiceTestDesc: "Kiểm tra xem tổng hợp giọng nói có hoạt động không",
                testVoiceText: "Kiểm tra giọng nói",
                // Status Messages
                readyStatus: "Sẵn sàng hỗ trợ bạn!",
                listeningStatus: "Đang nghe... Hãy nói ngay bây giờ!",
                voiceReadyStatus: "Giọng nói sẵn sàng - Nhấp để nói lại",
                processingStatus: "Đang xử lý...",
                speakingStatus: "Đang nói...",
                // Expressions
                readyExpression: "Sẵn sàng",
                listeningExpression: "Đang lắng nghe bạn...",
                processingExpression: "Đang xử lý...",
                respondingExpression: "Đang trả lời...",
                voiceErrorExpression: "Lỗi giọng nói",
                providerChangedExpression: "Đã thay đổi nhà cung cấp",
                apiKeySavedExpression: "Đã lưu khóa API",
                localAIExpression: "AI cục bộ",
                autoChatActiveExpression: "Trò chuyện tự động hoạt động",
                // Knowledge Base
                knowledgeBase: {
                    greetings: {
                        patterns: ['xin chào', 'chào', 'hello', 'hi'],
                        responses: [
                            "Xin chào! Tôi là trợ lý AI của bạn. Tôi có thể giúp gì cho bạn hôm nay?",
                            "Chào bạn! Tôi sẵn sàng hỗ trợ bạn với bất cứ điều gì bạn cần.",
                            "Xin chào! Tôi là người bạn đồng hành AI của bạn ở đây để giúp đỡ bạn.",
                            "Xin chào! Tôi có thể thấy bạn đã sẵn sàng tương tác. Bạn muốn làm gì?"
                        ],
                        expression: 'happy'
                    },
                    capabilities: {
                        patterns: ['bạn có thể làm gì', 'khả năng', 'tính năng', 'giúp đỡ'],
                        responses: [
                            "Tôi là một trợ lý AI hoàn chỉnh! Tôi có thể trò chuyện với bạn, hiểu lệnh thoại, thực hiện tính toán, cung cấp thông tin, kể chuyện cười và nhiều hơn nữa!",
                            "Là trợ lý AI của bạn, tôi cung cấp các cuộc trò chuyện thông minh, nhận dạng giọng nói, tự động hóa tác vụ và các chức năng tiện ích khác nhau.",
                            "Tôi được trang bị tổng hợp giọng nói, các cuộc trò chuyện được hỗ trợ bởi AI và các chức năng khác nhau để giúp bạn hàng ngày."
                        ],
                        expression: 'excited'
                    },
                    jokes: {
                        patterns: ['câu đùa', 'vui', 'cười', 'hài hước'],
                        responses: [
                            "Tại sao các nhà khoa học không tin tưởng nguyên tử? Bởi vì chúng tạo nên mọi thứ!",
                            "Tại sao bù nhìn lại thắng giải? Vì anh ấy xuất sắc trong lĩnh vực của mình!",
                            "Bạn gọi một sợi mì giả là gì? Một impasta!",
                            "Tại sao cuốn sách toán trông rất buồn? Vì nó có quá nhiều vấn đề!",
                            "Tại sao những bộ xương không đánh nhau? Chúng không có gan!"
                        ],
                        expression: 'happy'
                    },
                    facts: {
                        patterns: ['sự thật', 'thú vị', 'kể cho tôi nghe điều gì đó', 'bạn có biết'],
                        responses: [
                            "Bạn có biết? Cuộc chiến ngắn nhất trong lịch sử là giữa Anh và Zanzibar vào năm 1896. Nó chỉ kéo dài 38 phút!",
                            "Sự thật thú vị: Mật ong không bao giờ hỏng. Các nhà khảo cổ đã tìm thấy những bình mật ong trong các ngôi mộ Ai Cập cổ đại có tuổi đời hơn 3.000 năm!",
                            "Sự thật thú vị: Bạch tuộc có ba trái tim! Hai trái tim bơm máu qua mang, trong khi trái tim thứ ba bơm nó qua phần còn lại của cơ thể.",
                            "Bạn có biết? Chuối là quả mọng, nhưng dâu tây thì không!",
                            "Sự thật đáng kinh ngạc: Một nhóm hồng hạc được gọi là 'flamboyance'!"
                        ],
                        expression: 'thinking'
                    },
                    time: {
                        patterns: ['thời gian', 'đồng hồ', 'mấy giờ', 'giờ hiện tại'],
                        responses: [
                            `Thời gian hiện tại là ${new Date().toLocaleTimeString()}.`,
                            `Theo đồng hồ của tôi, bây giờ là ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}.`,
                            `Bây giờ là ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}.`
                        ],
                        expression: 'neutral'
                    },
                    weather: {
                        patterns: ['thời tiết', 'nhiệt độ', 'dự báo', 'thời tiết thế nào'],
                        getWeather: async function() {
                            try {
                                const now = new Date();
                                const month = now.getMonth();
                                const hour = now.getHours();
                                
                                let season, baseTemp, conditions;
                                
                                if (month >= 2 && month <= 4) {
                                    season = "mùa xuân";
                                    baseTemp = 15;
                                    conditions = ["nắng nhẹ với gió nhẹ", "mây rải rác", "mưa nhẹ"];
                                } else if (month >= 5 && month <= 7) {
                                    season = "mùa hè";
                                    baseTemp = 25;
                                    conditions = ["nắng và ấm áp", "trời quang", "mây rải rác"];
                                } else if (month >= 8 && month <= 10) {
                                    season = "mùa thu";
                                    baseTemp = 18;
                                    conditions = ["trời mát mẻ và trong lành", "gió nhẹ", "mưa nhẹ"];
                                } else {
                                    season = "mùa đông";
                                    baseTemp = 5;
                                    conditions = ["lạnh và trong", "trời âm u", "tuyết nhẹ"];
                                }
                                
                                if (hour >= 22 || hour < 6) {
                                    baseTemp -= 5;
                                    conditions = ["đêm trong", "mây rải rác", "mát mẻ và yên tĩnh"];
                                } else if (hour >= 6 && hour < 12) {
                                    baseTemp += 2;
                                } else if (hour >= 12 && hour < 18) {
                                    baseTemp += 5;
                                }
                                
                                const tempVariation = Math.floor(Math.random() * 8) - 4;
                                const finalTemp = baseTemp + tempVariation;
                                const condition = conditions[Math.floor(Math.random() * conditions.length)];
                                
                                return `Thời tiết mô phỏng hiện tại: ${finalTemp}°C với ${condition}. Dựa trên ${season} và thời gian trong ngày.`;
                            } catch (error) {
                                console.error('Weather error:', error);
                                return "Tôi đang gặp sự cố khi truy cập dữ liệu thời tiết ngay bây giờ. Vui lòng thử lại sau hoặc kiểm tra dịch vụ thời tiết trực tuyến.";
                            }
                        },
                        expression: 'neutral'
                    },
                    math: {
                        patterns: ['tính toán', 'toán', 'phương trình'],
                        calculate: function(question) {
                            const mathRegex = /(\d+)\s*(cộng|\+|trừ|\-|nhân|\*|nhân với|chia cho|\/)\s*(\d+)/i;
                            const match = question.match(mathRegex);
                            
                            if (match) {
                                const num1 = parseInt(match[1]);
                                const num2 = parseInt(match[3]);
                                const operation = match[2].toLowerCase();
                                
                                let result;
                                switch(operation) {
                                    case 'cộng': case '+': 
                                        result = num1 + num2;
                                        return `Kết quả là ${num1} + ${num2} = ${result}`;
                                    case 'trừ': case '-':
                                        result = num1 - num2;
                                        return `Kết quả là ${num1} - ${num2} = ${result}`;
                                    case 'nhân': case '*': case 'nhân với':
                                        result = num1 * num2;
                                        return `Kết quả là ${num1} × ${num2} = ${result}`;
                                    case 'chia cho': case '/':
                                        if (num2 === 0) return "Tôi không thể chia cho số không!";
                                        result = num1 / num2;
                                        return `Kết quả là ${num1} ÷ ${num2} = ${result}`;
                                }
                            }
                            return "Tôi có thể giúp tính toán! Hãy thử nói 'tính 15 cộng 27'";
                        },
                        expression: 'thinking'
                    },
                    conversation: {
                        patterns: ['bạn khỏe không', 'bạn cảm thấy thế nào', 'bạn nghĩ gì'],
                        responses: [
                            "Tôi đang rất tốt! Cảm ơn bạn đã hỏi. Tôi thích có những cuộc trò chuyện với bạn.",
                            "Tôi cảm thấy tuyệt vời! Mỗi tương tác giúp tôi học hỏi và cải thiện.",
                            "Tôi rất vui khi được trò chuyện với bạn! Hôm nay bạn có điều gì trong tâm trí?",
                            "Tôi đang ổn, cảm ơn bạn! Tôi thích các cuộc trò chuyện của chúng ta."
                        ],
                        expression: 'happy'
                    },
                    introduce: {
                        patterns: ['giới thiệu', 'bạn là ai', 'bạn là gì'],
                        responses: [
                            "Tôi là trợ lý AI của bạn, một AI trò chuyện hoàn toàn chức năng với biểu cảm hoạt hình và khả năng giọng nói!",
                            "Tôi là một trợ lý AI thời gian thực được thiết kế để giúp bạn với các nhiệm vụ khác nhau và có các cuộc trò chuyện hấp dẫn.",
                            "Tôi là một trợ lý AI tiên tiến với theo dõi mắt, biểu cảm khuôn mặt và khả năng tương tác bằng giọng nói."
                        ],
                        expression: 'excited'
                    },
                    news: {
                        patterns: ['tin tức', 'tiêu đề', 'mới nhất'],
                        responses: [
                            "Tôi không có quyền truy cập tin tức thời gian thực trong chế độ hiện tại của mình, nhưng tôi có thể thảo luận các chủ đề chung với bạn!",
                            "Để có tin tức mới nhất, tôi khuyên bạn nên kiểm tra một trang web tin tức. Tôi giỏi hơn trong các cuộc trò chuyện và tính toán!",
                            "Tôi chuyên về các cuộc trò chuyện tương tác hơn là cập nhật tin tức. Tôi có thể giúp gì khác cho bạn?"
                        ],
                        expression: 'neutral'
                    },
                    unknown: {
                        responses: [
                            "Đó là một câu hỏi thú vị! Tôi hiện đang sử dụng cơ sở kiến thức cục bộ của mình.",
                            "Tôi không chắc về chủ đề cụ thể đó trong chế độ hiện tại của mình. Bạn có muốn hỏi về điều gì khác không?",
                            "Điều đó vượt quá kiến thức hiện tại của tôi. Tôi chuyên về các cuộc trò chuyện, tính toán và hỗ trợ chung.",
                            "Tôi không có thông tin về điều đó ngay bây giờ. Hãy thử hỏi tôi về các chủ đề chung hoặc kích hoạt AI trực tuyến để có thêm khả năng!"
                        ],
                        expression: 'confused'
                    }
                }
            },
            ur: {
                name: "اردو",
                direction: "rtl",
                // UI Texts
                appTitle: "AI اسسٹنٹ",
                connectionText: "AI: لوکل موڈ",
                statusText: "حالت:",
                moodText: "موڈ:",
                voiceStatusText: "آواز:",
                instructionPlaceholder: "مجھ سے کچھ بھی پوچھیں...",
                voiceBtnText: "وائس کمانڈ",
                greetText: "سلام",
                jokeText: "مذاق",
                factText: "حقیقت",
                timeText: "وقت",
                calculateText: "حساب کتاب",
                weatherText: "موسم",
                newsText: "خبریں",
                introduceText: "تعارف",
                welcomeMessage: "ہیلو! میں آپ کا AI اسسٹنٹ ہوں۔ بہتر صلاحیتوں کے لیے اپنی پسندیدہ AI فراہم کنندہ کو نیچے منتخب کریں!",
                groqNotice: "Groq API مفت اور سپر فاسٹ ہے - ٹیسٹنگ کے لیے تجویز کردہ!",
                chatPlaceholder: "اپنا پیغام یہاں ٹائپ کریں...",
                clearChatText: "چیٹ صاف کریں",
                autoChatText: "خودکار چیٹ",
                configTitle: "AI کنفیگریشن",
                providerLabel: "AI فراہم کنندہ:",
                localOption: "صرف لوکل AI",
                groqOption: "Groq (Llama 3 - مفت اور تیز)",
                openaiOption: "OpenAI (GPT-3.5/4)",
                groqTitle: "Groq (تجویز کردہ):",
                groqPoint1: "✅ بیٹا کے دوران مکمل طور پر مفت",
                groqPoint2: "✅ کریڈٹ کارڈ کی ضرورت نہیں",
                groqPoint3: "✅ بجلی کی طرح تیز جوابات",
                groqLink: "API کلید حاصل کریں:",
                apiKeyPlaceholder: "لوکل AI کے لیے API کلید کی ضرورت نہیں",
                saveText: "محفوظ کریں",
                enableVoiceText: "آواز فعال کریں",
                continuousModeText: "مسلسل موڈ",
                voiceTestTitle: "آواز کی جانچ:",
                voiceTestDesc: "چیک کریں کہ سپیچ سنتھیسس کام کرتا ہے",
                testVoiceText: "آواز کی جانچ",
                // Status Messages
                readyStatus: "آپ کی مدد کے لیے تیار!",
                listeningStatus: "سن رہا ہوں... ابھی بولیں!",
                voiceReadyStatus: "آواز تیار ہے - دوبارہ بولنے کے لیے کلک کریں",
                processingStatus: "پروسس ہو رہا ہے...",
                speakingStatus: "بول رہا ہوں...",
                // Expressions
                readyExpression: "تیار",
                listeningExpression: "آپ کو سن رہا ہوں...",
                processingExpression: "پروسس ہو رہا ہے...",
                respondingExpression: "جواب دے رہا ہوں...",
                voiceErrorExpression: "آواز کی خرابی",
                providerChangedExpression: "فراہم کنندہ تبدیل ہو گیا",
                apiKeySavedExpression: "API کلید محفوظ ہو گئی",
                localAIExpression: "لوکل AI",
                autoChatActiveExpression: "خودکار چیٹ فعال",
                // Knowledge Base
                knowledgeBase: {
                    greetings: {
                        patterns: ['ہیلو', 'سلام', 'ہائے', 'خوش آمدید', 'صبح بخیر', 'دوپہر بخیر', 'شام بخیر'],
                        responses: [
                            "ہیلو! میں آپ کا AI اسسٹنٹ ہوں۔ آج میں آپ کی کس طرح مدد کر سکتا ہوں؟",
                            "ہائے وہاں! میں آپ کی کسی بھی چیز میں مدد کے لیے تیار ہوں۔",
                            "خوش آمدید! میں آپ کا AI ساتھی ہوں جو آپ کی مدد کے لیے یہاں ہے۔",
                            "ہیلو! میں دیکھ سکتا ہوں کہ آپ بات چیت کے لیے تیار ہیں۔ آپ کیا کرنا چاہیں گے؟"
                        ],
                        expression: 'happy'
                    },
                    capabilities: {
                        patterns: ['آپ کیا کر سکتے ہیں', 'صلاحیتیں', 'خصوصیات', 'مدد'],
                        responses: [
                            "میں ایک مکمل AI اسسٹنٹ ہوں! میں آپ سے بات چیت کر سکتا ہوں، وائس کمانڈز سمجھ سکتا ہوں، حساب کتاب کر سکتا ہوں، معلومات فراہم کر سکتا ہوں، لطیفے سنا سکتا ہوں، اور بہت کچھ!",
                            "آپ کے AI اسسٹنٹ کے طور پر، میں ذہین گفتگو، وائس ریکگنیشن، کام کی خودکاریت، اور مختلف یوٹیلیٹی فنکشنز پیش کرتا ہوں۔",
                            "میں سپیچ سنتھیسس، AI سے چلنے والی گفتگو، اور روزانہ آپ کی مدد کرنے کے لیے مختلف افعال سے لیس ہوں۔"
                        ],
                        expression: 'excited'
                    },
                    jokes: {
                        patterns: ['لطیفہ', 'مزاحیہ', 'ہنسو', 'مذاق'],
                        responses: [
                            "سائنسدان ایٹم پر کیوں بھروسہ نہیں کرتے؟ کیونکہ وہ سب کچھ بنا دیتے ہیں!",
                            "بھوسے کے آدمی نے انعام کیوں جیتا؟ کیونکہ وہ اپنے میدان میں نمایاں تھا!",
                            "آپ جعلی نوڈلز کو کیا کہتے ہیں؟ ایک امپاسٹا!",
                            "ریاضی کی کتاب اتنی اداس کیوں لگ رہی تھی؟ کیونکہ اس کے بہت سارے مسائل تھے!",
                            "کंکال ایک دوسرے سے کیوں نہیں لڑتے؟ ان میں ہمت نہیں ہے!"
                        ],
                        expression: 'happy'
                    },
                    facts: {
                        patterns: ['حقیقت', 'دلچسپ', 'مجھے کچھ بتاؤ', 'کیا آپ جانتے ہیں'],
                        responses: [
                            "کیا آپ جانتے ہیں؟ تاریخ کا مختصر ترین جنگ برطانیہ اور زنجبار کے درمیان 1896 میں ہوئی تھی۔ یہ صرف 38 منٹ تک جاری رہی!",
                            "دلچسپ حقیقت: شہد کبھی خراب نہیں ہوتا۔ ماہرین آثار قدیمہ نے قدیم مصری مقبروں میں شہد کے برتن تلاش کیے ہیں جو 3,000 سال سے زیادہ پرانے ہیں!",
                            "مزےدار حقیقت: آکٹوپس کے تین دل ہوتے ہیں! دو دل گلفڑوں کے ذریعے خون پمپ کرتے ہیں، جبکہ تیسرا دل اسے باقی جسم کے ذریعے پمپ کرتا ہے۔",
                            "کیا آپ جانتے ہیں؟ کیلا بیریز ہیں، لیکن اسٹرابیری نہیں ہیں!",
                            "حیرت انگیز حقیقت: فلیمنگو کے گروپ کو 'flamboyance' کہا جاتا ہے!"
                        ],
                        expression: 'thinking'
                    },
                    time: {
                        patterns: ['وقت', 'گھڑی', 'کتنے بجے', 'موجودہ وقت'],
                        responses: [
                            `موجودہ وقت ${new Date().toLocaleTimeString()} ہے۔`,
                            `میری گھڑی کے مطابق، اب ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} بجے ہیں۔`,
                            `اب ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})} بجے ہیں۔`
                        ],
                        expression: 'neutral'
                    },
                    weather: {
                        patterns: ['موسم', 'درجہ حرارت', 'پیشن گوئی', 'موسم کیسا ہے'],
                        getWeather: async function() {
                            try {
                                const now = new Date();
                                const month = now.getMonth();
                                const hour = now.getHours();
                                
                                let season, baseTemp, conditions;
                                
                                if (month >= 2 && month <= 4) {
                                    season = "بہار";
                                    baseTemp = 15;
                                    conditions = ["دھوپ اور ہلکی ہوا", "جزوی طور پر ابر آلود", "ہلکی بارش"];
                                } else if (month >= 5 && month <= 7) {
                                    season = "گرمی";
                                    baseTemp = 25;
                                    conditions = ["دھوپ اور گرم", "صاف آسمان", "جزوی طور پر ابر آلود"];
                                } else if (month >= 8 && month <= 10) {
                                    season = "خزاں";
                                    baseTemp = 18;
                                    conditions = ["خوشگوار اور صاف", "ہوادار", "ہلکی بارش"];
                                } else {
                                    season = "سردی";
                                    baseTemp = 5;
                                    conditions = ["ٹھنڈا اور صاف", "ابر آلود", "ہلکی برف باری"];
                                }
                                
                                if (hour >= 22 || hour < 6) {
                                    baseTemp -= 5;
                                    conditions = ["صاف رات", "جزوی طور پر ابر آلود", "ٹھنڈا اور پرسکون"];
                                } else if (hour >= 6 && hour < 12) {
                                    baseTemp += 2;
                                } else if (hour >= 12 && hour < 18) {
                                    baseTemp += 5;
                                }
                                
                                const tempVariation = Math.floor(Math.random() * 8) - 4;
                                const finalTemp = baseTemp + tempVariation;
                                const condition = conditions[Math.floor(Math.random() * conditions.length)];
                                
                                return `موجودہ مصنوعی موسم: ${finalTemp}°C ساتھ ${condition}۔ ${season} کے موسم اور دن کے وقت پر مبنی۔`;
                            } catch (error) {
                                console.error('Weather error:', error);
                                return "مجھے ابھی موسم کے ڈیٹا تک رسائی حاصل کرنے میں دشواری ہو رہی ہے۔ براہ کرم بعد میں دوبارہ کوشش کریں یا آن لائن موسم کی سروس چیک کریں۔";
                            }
                        },
                        expression: 'neutral'
                    },
                    math: {
                        patterns: ['حساب کریں', 'ریاضی', 'مساوات'],
                        calculate: function(question) {
                            const mathRegex = /(\d+)\s*(جمع|\+|منفی|\-|ضرب|\*|سے ضرب|سے تقسیم|\/)\s*(\d+)/i;
                            const match = question.match(mathRegex);
                            
                            if (match) {
                                const num1 = parseInt(match[1]);
                                const num2 = parseInt(match[3]);
                                const operation = match[2].toLowerCase();
                                
                                let result;
                                switch(operation) {
                                    case 'جمع': case '+': 
                                        result = num1 + num2;
                                        return `جواب ہے ${num1} + ${num2} = ${result}`;
                                    case 'منفی': case '-':
                                        result = num1 - num2;
                                        return `جواب ہے ${num1} - ${num2} = ${result}`;
                                    case 'ضرب': case '*': case 'سے ضرب':
                                        result = num1 * num2;
                                        return `جواب ہے ${num1} × ${num2} = ${result}`;
                                    case 'سے تقسیم': case '/':
                                        if (num2 === 0) return "میں صفر سے تقسیم نہیں کر سکتا!";
                                        result = num1 / num2;
                                        return `جواب ہے ${num1} ÷ ${num2} = ${result}`;
                                }
                            }
                            return "میں حساب کتاب میں مدد کر سکتا ہوں! '15 جمع 27 حساب کریں' جیسے کچھ کہہ کر آزمائیں";
                        },
                        expression: 'thinking'
                    },
                    conversation: {
                        patterns: ['آپ کیسے ہیں', 'آپ کیسا محسوس کر رہے ہیں', 'آپ کیا سوچتے ہیں'],
                        responses: [
                            "میں بہت اچھا ہوں! پوچھنے کا شکریہ۔ مجھے آپ کے ساتھ گفتگو کرنا پسند ہے۔",
                            "میں شاندار محسوس کر رہا ہوں! ہر تعامل مجھے سیکھنے اور بہتر بننے میں مدد کرتا ہے۔",
                            "میں آپ سے بات چیت کر کے بہت پرجوش ہوں! آج آپ کے ذہن میں کیا ہے؟",
                            "میں ٹھیک ہوں، آپ کا شکریہ! مجھے ہماری گفتگو پسند ہے۔"
                        ],
                        expression: 'happy'
                    },
                    introduce: {
                        patterns: ['تعارف', 'آپ کون ہیں', 'آپ کیا ہیں'],
                        responses: [
                            "میں آپ کا AI اسسٹنٹ ہوں، ایک مکمل طور پر فعال گفتگو کرنے والا AI جو متحرک تاثرات اور وائس کی صلاحیتوں کے ساتھ ہے!",
                            "میں ایک ریئل ٹائم AI اسسٹنٹ ہوں جو مختلف کاموں میں آپ کی مدد کرنے اور پرکشش گفتگو کرنے کے لیے ڈیزائن کیا گیا ہے۔",
                            "میں ایک جدید AI اسسٹنٹ ہوں جس میں آنکھوں کی ٹریکنگ، چہرے کے تاثرات، اور وائس انٹرایکشن کی صلاحیتیں ہیں۔"
                        ],
                        expression: 'excited'
                    },
                    news: {
                        patterns: ['خبریں', 'سرخیوں', 'تازہ ترین'],
                        responses: [
                            "میرے پاس موجودہ موڈ میں ریئل ٹائم نیوز تک رسائی نہیں ہے، لیکن میں آپ کے ساتھ عمومی موضوعات پر بات چیت کر سکتا ہوں!",
                            "تازہ ترین خبروں کے لیے، میں نیوز ویب سائٹ چیک کرنے کی سفارش کروں گا۔ میں گفتگو اور حساب کتاب میں بہتر ہوں!",
                            "میں نیوز اپ ڈیٹس کے بجائے انٹرایکٹو گفتگو میں مہارت رکھتا ہوں۔ میں آپ کی اور کس چیز میں مدد کر سکتا ہوں؟"
                        ],
                        expression: 'neutral'
                    },
                    unknown: {
                        responses: [
                            "یہ ایک دلچسپ سوال ہے! میں فی الحال اپنے مقامی علم کے ڈیٹا بیس کا استعمال کر رہا ہوں۔",
                            "میں اپنے موجودہ موڈ میں اس مخصوص موضوع کے بارے میں یقین سے نہیں کہہ سکتا۔ کیا آپ کچھ اور پوچھنا چاہیں گے؟",
                            "یہ میرے موجودہ علم سے باہر ہے۔ میں گفتگو، حساب کتاب، اور عمومی مدد میں مہارت رکھتا ہوں۔",
                            "میرے پاس اس وقت اس بارے میں معلومات نہیں ہیں۔ عمومی موضوعات کے بارے میں مجھ سے پوچھنے کی کوشش کریں یا مزید صلاحیتوں کے لیے آن لائن AI کو فعال کریں!"
                        ],
                        expression: 'confused'
                    }
                }
            }
        };

        // Current language
        let currentLanguage = localStorage.getItem('ai-language') || 'en';
        let currentLangData = languages[currentLanguage];

        // DOM Elements
        const humanFace = document.getElementById('human-face');
        const faceStatus = document.getElementById('face-status');
        const expressionIndicator = document.getElementById('expression-indicator');
        const expressionText = document.getElementById('expression-text');
        const expressionIcon = document.getElementById('expression-icon');
        const instructionInput = document.getElementById('instruction-input');
        const executeBtn = document.getElementById('execute-btn');
        const voiceBtn = document.getElementById('voice-btn');
        const status = document.getElementById('status');
        const commandBtns = document.querySelectorAll('.command-btn');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const clearChatBtn = document.getElementById('clear-chat-btn');
        const autoChatBtn = document.getElementById('auto-chat-btn');
        const apiKeyInput = document.getElementById('api-key-input');
        const aiProviderSelect = document.getElementById('ai-provider');
        const saveApiKeyBtn = document.getElementById('save-api-key-btn');
        const connectionStatus = document.getElementById('connection-status');
        const enableVoiceBtn = document.getElementById('enable-voice-btn');
        const continuousModeBtn = document.getElementById('continuous-mode-btn');
        const testVoiceBtn = document.getElementById('test-voice-btn');
        const voiceDebug = document.getElementById('voice-debug');
        const robotInfo = document.getElementById('robot-info');
        const mouth = document.getElementById('mouth');
        const pupilLeft = document.getElementById('pupil-left');
        const pupilRight = document.getElementById('pupil-right');
        const faceWrapper = document.querySelector('.face-wrapper');
        const happyOverlay = document.getElementById('happy-overlay');
        const sadOverlay = document.getElementById('sad-overlay');
        const thinkingOverlay = document.getElementById('thinking-overlay');
        const excitedOverlay = document.getElementById('excited-overlay');
        const providerInfo = document.getElementById('provider-info');
        const languageBtn = document.getElementById('language-btn');
        const languageDropdown = document.getElementById('language-dropdown');
        const currentLanguageText = document.getElementById('current-language');

        // State variables
        let aiConfig = {
            provider: localStorage.getItem('ai-provider') || 'local',
            apiKey: localStorage.getItem('ai-api-key') || '',
            enabled: false
        };

        let isTalking = false;
        let currentExpression = 'neutral';
        let voiceEnabled = true;
        let continuousMode = false;
        let autoChatActive = false;
        let expressionTimeout = null;
        let conversationHistory = [];
        let autoChatInterval = null;
        let speechSupported = false;
        let voiceRecognitionSupported = false;
        let isListening = false;
        let recognition = null;
        let knowledgeBase = currentLangData.knowledgeBase;

        // Language functions
        function changeLanguage(langCode) {
            currentLanguage = langCode;
            currentLangData = languages[langCode];
            localStorage.setItem('ai-language', langCode);
            
            // Update UI direction
            document.body.classList.toggle('rtl', currentLangData.direction === 'rtl');
            
            // Update all text elements
            updateUIText();
            
            // Update knowledge base
            knowledgeBase = currentLangData.knowledgeBase;
            
            // Update dropdown
            updateLanguageDropdown();
            
            // Update status
            status.textContent = currentLangData.readyStatus;
            setExpression('happy', currentLangData.readyExpression);
            
            // Reinitialize voice recognition with new language
            if (voiceRecognitionSupported) {
                recognition = initializeVoiceRecognition();
            }
        }

        function updateUIText() {
            // Update all text elements with current language data
            document.getElementById('app-title').textContent = currentLangData.appTitle;
            document.getElementById('connection-text').textContent = currentLangData.connectionText;
            document.getElementById('status-text').textContent = currentLangData.statusText;
            document.getElementById('mood-text').textContent = currentLangData.moodText;
            document.getElementById('voice-status-text').textContent = currentLangData.voiceStatusText;
            instructionInput.placeholder = currentLangData.instructionPlaceholder;
            document.getElementById('voice-btn-text').textContent = currentLangData.voiceBtnText;
            document.getElementById('greet-text').textContent = currentLangData.greetText;
            document.getElementById('joke-text').textContent = currentLangData.jokeText;
            document.getElementById('fact-text').textContent = currentLangData.factText;
            document.getElementById('time-text').textContent = currentLangData.timeText;
            document.getElementById('calculate-text').textContent = currentLangData.calculateText;
            document.getElementById('weather-text').textContent = currentLangData.weatherText;
            document.getElementById('news-text').textContent = currentLangData.newsText;
            document.getElementById('introduce-text').textContent = currentLangData.introduceText;
            document.getElementById('welcome-message').textContent = currentLangData.welcomeMessage;
            document.getElementById('groq-notice').textContent = currentLangData.groqNotice;
            chatInput.placeholder = currentLangData.chatPlaceholder;
            document.getElementById('clear-chat-text').textContent = currentLangData.clearChatText;
            document.getElementById('auto-chat-text').textContent = currentLangData.autoChatText;
            document.getElementById('config-title').textContent = currentLangData.configTitle;
            document.getElementById('provider-label').textContent = currentLangData.providerLabel;
            document.getElementById('local-option').textContent = currentLangData.localOption;
            document.getElementById('groq-option').textContent = currentLangData.groqOption;
            document.getElementById('openai-option').textContent = currentLangData.openaiOption;
            document.getElementById('groq-title').textContent = currentLangData.groqTitle;
            document.getElementById('groq-point1').textContent = currentLangData.groqPoint1;
            document.getElementById('groq-point2').textContent = currentLangData.groqPoint2;
            document.getElementById('groq-point3').textContent = currentLangData.groqPoint3;
            document.getElementById('groq-link').innerHTML = currentLangData.groqLink + ' <a href="https://console.groq.com" target="_blank" style="color: #4ade80;">console.groq.com</a>';
            apiKeyInput.placeholder = currentLangData.apiKeyPlaceholder;
            document.getElementById('save-text').textContent = currentLangData.saveText;
            document.getElementById('enable-voice-text').textContent = currentLangData.enableVoiceText;
            document.getElementById('continuous-mode-text').textContent = currentLangData.continuousModeText;
            document.getElementById('voice-test-title').textContent = currentLangData.voiceTestTitle;
            document.getElementById('voice-test-desc').textContent = currentLangData.voiceTestDesc;
            document.getElementById('test-voice-text').textContent = currentLangData.testVoiceText;
            
            // Update current language display
            currentLanguageText.textContent = currentLangData.name;
        }

        function updateLanguageDropdown() {
            const options = document.querySelectorAll('.language-option');
            options.forEach(option => {
                const check = option.querySelector('.language-check');
                if (option.dataset.lang === currentLanguage) {
                    option.classList.add('active');
                    check.style.display = 'inline-block';
                } else {
                    option.classList.remove('active');
                    check.style.display = 'none';
                }
            });
        }

        // Enhanced Voice Recognition System
        function initializeVoiceRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                voiceRecognitionSupported = false;
                voiceBtn.style.display = 'none';
                updateVoiceStatus('Voice recognition not supported in this browser', 'error');
                return null;
            }

            voiceRecognitionSupported = true;
            
            const recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = currentLanguage === 'en' ? 'en-US' : 
                              currentLanguage === 'vi' ? 'vi-VN' : 'ur-PK';
            recognition.maxAlternatives = 1;

            recognition.onstart = () => {
                isListening = true;
                updateVoiceStatus(currentLangData.listeningStatus, 'listening');
                setExpression('thinking', currentLangData.listeningExpression);
                voiceBtn.innerHTML = `<i class="fas fa-microphone-slash"></i> <span id="voice-btn-text">${currentLangData.voiceBtnText}</span>`;
                voiceBtn.style.background = '#f44336';
            };

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('Voice recognized:', transcript);
                
                instructionInput.value = transcript;
                updateVoiceStatus(`Heard: "${transcript}"`, 'ready');
                
                // Process after a short delay to show feedback
                setTimeout(() => {
                    processInstruction(transcript);
                }, 500);
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                isListening = false;
                resetVoiceButton();
                
                let errorMessage = 'Voice recognition error';
                switch(event.error) {
                    case 'not-allowed':
                    case 'permission-denied':
                        errorMessage = 'Microphone permission denied. Please allow microphone access.';
                        break;
                    case 'network':
                        errorMessage = 'Network error occurred during voice recognition';
                        break;
                    case 'no-speech':
                        errorMessage = 'No speech detected. Please try again.';
                        break;
                    case 'audio-capture':
                        errorMessage = 'No microphone found. Please check your microphone.';
                        break;
                    default:
                        errorMessage = `Voice error: ${event.error}`;
                }
                
                updateVoiceStatus(errorMessage, 'error');
                setExpression('sad', currentLangData.voiceErrorExpression);
            };

            recognition.onend = () => {
                isListening = false;
                resetVoiceButton();
                
                // Only clear status if we're not in an error state
                if (!status.textContent.includes('error') && !status.textContent.includes('denied')) {
                    setTimeout(() => {
                        updateVoiceStatus(currentLangData.voiceReadyStatus, 'ready');
                    }, 1000);
                }
            };

            return recognition;
        }

        function updateVoiceStatus(message, type) {
            // Remove any existing voice status elements
            const existingStatus = document.querySelector('.voice-status');
            if (existingStatus) {
                existingStatus.remove();
            }

            const statusElement = document.createElement('div');
            statusElement.className = `voice-status voice-${type}`;
            statusElement.innerHTML = `<i class="fas fa-${getStatusIcon(type)}"></i> ${message}`;
            
            voiceDebug.appendChild(statusElement);
        }

        function getStatusIcon(type) {
            switch(type) {
                case 'listening': return 'ear-listen';
                case 'ready': return 'check-circle';
                case 'error': return 'exclamation-triangle';
                default: return 'info-circle';
            }
        }

        function resetVoiceButton() {
            voiceBtn.innerHTML = `<i class="fas fa-microphone"></i> <span id="voice-btn-text">${currentLangData.voiceBtnText}</span>`;
            voiceBtn.style.background = '';
            updateUIText(); // Update button text
        }

        // Initialize voice recognition
        recognition = initializeVoiceRecognition();

        // Check speech synthesis support
        function checkSpeechSupport() {
            speechSupported = 'speechSynthesis' in window;
            
            if (!speechSupported) {
                voiceDebug.innerHTML = '<span style="color: #ff6b6b">Speech synthesis not supported in this browser</span>';
                enableVoiceBtn.disabled = true;
                testVoiceBtn.disabled = true;
                voiceEnabled = false;
            } else {
                // Load voices and then update status
                const voices = window.speechSynthesis.getVoices();
                if (voices.length === 0) {
                    window.speechSynthesis.onvoiceschanged = () => {
                        const loadedVoices = window.speechSynthesis.getVoices();
                        updateVoiceSupportStatus(loadedVoices);
                    };
                } else {
                    updateVoiceSupportStatus(voices);
                }
            }
        }

        function updateVoiceSupportStatus(voices) {
            const voiceCount = voices.length;
            let statusMessage = `<span style="color: #4ade80">Speech synthesis supported - ${voiceCount} voices available</span>`;
            
            if (voiceCount === 0) {
                statusMessage = '<span style="color: #ff6b6b">Speech synthesis supported but no voices available</span>';
            }
            
            voiceDebug.innerHTML = statusMessage;
            voiceEnabled = true;
            updateSystemStatus();
            
            console.log('Available voices:', voices);
        }

        // Initialize
        function initializeApp() {
            // Set initial language
            changeLanguage(currentLanguage);
            
            apiKeyInput.value = aiConfig.apiKey;
            aiProviderSelect.value = aiConfig.provider;
            updateAPIKeyPlaceholder();
            updateProviderInfo();
            checkAIStatus();
            updateSystemStatus();
            checkSpeechSupport();
            startEyeTracking();
            startBlinking();
        }

        // Eye Tracking System
        function startEyeTracking() {
            document.addEventListener('mousemove', trackEyes);
            document.addEventListener('mouseleave', resetEyes);
        }

        function trackEyes(event) {
            const faceRect = faceWrapper.getBoundingClientRect();
            const faceCenterX = faceRect.left + faceRect.width / 2;
            const faceCenterY = faceRect.top + faceRect.height / 2;
            const cursorX = event.clientX;
            const cursorY = event.clientY;
            const deltaX = (cursorX - faceCenterX) / (faceRect.width / 2);
            const deltaY = (cursorY - faceCenterY) / (faceRect.height / 2);
            const maxMovement = 4;
            const moveX = deltaX * maxMovement;
            const moveY = deltaY * maxMovement;
            
            pupilLeft.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
            pupilRight.style.transform = `translate(calc(-50% + ${moveX}px), calc(-50% + ${moveY}px))`;
        }

        function resetEyes() {
            pupilLeft.style.transform = 'translate(-50%, -50%)';
            pupilRight.style.transform = 'translate(-50%, -50%)';
        }

        // Blinking Animation
        function startBlinking() {
            const eyes = document.querySelectorAll('.eye');
            
            function blink() {
                eyes.forEach(eye => {
                    eye.style.height = '2px';
                    setTimeout(() => {
                        eye.style.height = '16px';
                    }, 150);
                });
                
                setTimeout(blink, 3000 + Math.random() * 5000);
            }
            
            blink();
        }

        // System Functions
        function checkAIStatus() {
            const hasValidConfig = aiConfig.provider !== 'local' && aiConfig.apiKey && navigator.onLine;
            aiConfig.enabled = hasValidConfig;
            
            if (hasValidConfig) {
                const statusClass = `status-${aiConfig.provider}`;
                connectionStatus.innerHTML = `<i class="fas fa-wifi ${statusClass}"></i><span>${aiConfig.provider.toUpperCase()} AI: Online</span>`;
            } else if (aiConfig.provider === 'local') {
                connectionStatus.innerHTML = '<i class="fas fa-microchip status-local"></i><span>AI: Local Mode</span>';
            } else {
                connectionStatus.innerHTML = '<i class="fas fa-microchip status-offline"></i><span>AI: Using Local</span>';
            }
        }

        function updateSystemStatus() {
            document.getElementById('ai-status').textContent = aiConfig.enabled ? aiConfig.provider.toUpperCase() : 'Local';
            document.getElementById('voice-status').textContent = voiceEnabled ? 'Active' : 'Disabled';
        }

        function updateAPIKeyPlaceholder() {
            const placeholders = {
                'openai': 'OpenAI API Key (sk-...)',
                'groq': 'Groq API Key (gsk_...)', 
                'local': currentLangData.apiKeyPlaceholder
            };
            apiKeyInput.placeholder = placeholders[aiConfig.provider];
            
            if (aiConfig.provider === 'local') {
                apiKeyInput.disabled = true;
                apiKeyInput.value = '';
            } else {
                apiKeyInput.disabled = false;
            }
        }

        function updateProviderInfo() {
            const providerInfoContent = {
                'openai': `
                    <strong>OpenAI:</strong>
                    <ul>
                        <li>✅ Advanced models (GPT-3.5, GPT-4)</li>
                        <li>✅ High quality responses</li>
                        <li>❌ Requires billing setup</li>
                        <li>Get API key: <a href="https://platform.openai.com" target="_blank" style="color: #8b5cf6;">platform.openai.com</a></li>
                    </ul>
                `,
                'groq': `
                    <strong>Groq (Recommended):</strong>
                    <ul>
                        <li>✅ Completely free during beta</li>
                        <li>✅ No credit card required</li>
                        <li>✅ Lightning fast responses</li>
                        <li>Get API key: <a href="https://console.groq.com" target="_blank" style="color: #10b981;">console.groq.com</a></li>
                    </ul>
                `,
                'local': `
                    <strong>Local AI:</strong>
                    <ul>
                        <li>✅ Always works offline</li>
                        <li>✅ No API key needed</li>
                        <li>✅ Basic responses only</li>
                        <li>Configure online AI for enhanced capabilities</li>
                    </ul>
                `
            };
            
            providerInfo.innerHTML = providerInfoContent[aiConfig.provider];
        }

        // Expression Management
        function setExpression(expression, message = '', duration = 5000) {
            currentExpression = expression;
            updateExpressionIndicator();
            
            humanFace.className = 'human-face';
            if (expression !== 'neutral') {
                humanFace.classList.add(`face-${expression}`);
            }
            
            happyOverlay.classList.remove('active');
            sadOverlay.classList.remove('active');
            thinkingOverlay.classList.remove('active');
            excitedOverlay.classList.remove('active');
            
            switch(expression) {
                case 'happy': happyOverlay.classList.add('active'); break;
                case 'sad': sadOverlay.classList.add('active'); break;
                case 'thinking': thinkingOverlay.classList.add('active'); break;
                case 'excited': excitedOverlay.classList.add('active'); break;
            }
            
            document.getElementById('current-mood').textContent = expression.charAt(0).toUpperCase() + expression.slice(1);
            document.getElementById('current-status').textContent = message || currentLangData.readyExpression;
            
            if (expressionTimeout) clearTimeout(expressionTimeout);
            
            if (expression !== 'neutral') {
                expressionTimeout = setTimeout(() => {
                    setExpression('neutral', currentLangData.readyExpression);
                }, duration);
            }
        }

        function updateExpressionIndicator() {
            expressionText.textContent = currentExpression.charAt(0).toUpperCase() + currentExpression.slice(1);
            
            switch(currentExpression) {
                case 'happy': expressionIcon.className = 'fas fa-smile'; break;
                case 'sad': expressionIcon.className = 'fas fa-frown'; break;
                case 'thinking': expressionIcon.className = 'fas fa-brain'; break;
                case 'excited': expressionIcon.className = 'fas fa-star'; break;
                case 'confused': expressionIcon.className = 'fas fa-question'; break;
                case 'surprised': expressionIcon.className = 'fas fa-surprise'; break;
                default: expressionIcon.className = 'fas fa-meh';
            }
        }

        // AI Provider Selection Handler
        aiProviderSelect.addEventListener('change', function() {
            aiConfig.provider = this.value;
            updateAPIKeyPlaceholder();
            updateProviderInfo();
            checkAIStatus();
            updateSystemStatus();
            
            status.textContent = `Switched to ${aiConfig.provider.toUpperCase()} mode`;
            setExpression('happy', currentLangData.providerChangedExpression);
        });

        // Save API Key Handler
        saveApiKeyBtn.addEventListener('click', () => {
            aiConfig.apiKey = apiKeyInput.value.trim();
            
            if (aiConfig.provider !== 'local' && aiConfig.apiKey) {
                localStorage.setItem('ai-provider', aiConfig.provider);
                localStorage.setItem('ai-api-key', aiConfig.apiKey);
                status.textContent = `${aiConfig.provider.toUpperCase()} API key saved!`;
                setExpression('happy', currentLangData.apiKeySavedExpression);
            } else if (aiConfig.provider === 'local') {
                localStorage.removeItem('ai-provider');
                localStorage.removeItem('ai-api-key');
                status.textContent = 'Using local AI only';
                setExpression('neutral', currentLangData.localAIExpression);
            } else {
                localStorage.removeItem('ai-provider');
                localStorage.removeItem('ai-api-key');
                status.textContent = 'API key removed';
                setExpression('neutral', currentLangData.localAIExpression);
            }
            
            checkAIStatus();
            updateSystemStatus();
        });

        // Enhanced Voice Button Handler
        voiceBtn.addEventListener('click', () => {
            if (!voiceRecognitionSupported) {
                updateVoiceStatus('Voice recognition not supported in this browser', 'error');
                return;
            }
            
            if (!voiceEnabled) {
                updateVoiceStatus('Please enable voice recognition first', 'error');
                return;
            }
            
            if (isListening) {
                // Stop listening
                recognition.stop();
                isListening = false;
                resetVoiceButton();
                updateVoiceStatus('Voice recognition stopped', 'ready');
                setExpression('neutral', currentLangData.readyExpression);
            } else {
                // Start listening
                try {
                    recognition.start();
                    updateVoiceStatus(currentLangData.listeningStatus, 'listening');
                    setExpression('thinking', currentLangData.listeningExpression);
                } catch (error) {
                    console.error('Error starting voice recognition:', error);
                    updateVoiceStatus('Error starting voice recognition', 'error');
                    setExpression('sad', currentLangData.voiceErrorExpression);
                }
            }
        });

        // Other event listeners
        executeBtn.addEventListener('click', () => {
            const instruction = instructionInput.value.trim();
            if (instruction) processInstruction(instruction);
        });

        instructionInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const instruction = instructionInput.value.trim();
                if (instruction) processInstruction(instruction);
            }
        });

        commandBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const command = btn.getAttribute('data-command');
                processInstruction(command);
            });
        });

        sendChatBtn.addEventListener('click', sendChatMessage);
        
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatMessage();
            }
        });

        clearChatBtn.addEventListener('click', () => {
            chatMessages.innerHTML = '';
            conversationHistory = [];
            addChatMessage(currentLangData.welcomeMessage, "robot");
            setExpression('neutral', currentLangData.readyExpression);
        });

        autoChatBtn.addEventListener('click', toggleAutoChat);

        enableVoiceBtn.addEventListener('click', () => {
            voiceEnabled = !voiceEnabled;
            enableVoiceBtn.innerHTML = voiceEnabled ? 
                `<i class="fas fa-microphone-slash"></i> ${currentLangData.enableVoiceText}` : 
                `<i class="fas fa-microphone-alt"></i> ${currentLangData.enableVoiceText}`;
            updateSystemStatus();
            status.textContent = voiceEnabled ? 'Voice recognition enabled!' : 'Voice recognition disabled';
            setExpression(voiceEnabled ? 'happy' : 'neutral', voiceEnabled ? 'Voice enabled' : 'Voice disabled');
            
            if (voiceEnabled) {
                updateVoiceStatus('Voice enabled. Click "Voice Command" to speak.', 'ready');
            } else {
                updateVoiceStatus('Voice disabled', 'error');
            }
            
            updateUIText(); // Update button text
        });

        testVoiceBtn.addEventListener('click', () => {
            if (!speechSupported) {
                updateVoiceStatus('Speech synthesis not supported', 'error');
                return;
            }
            
            updateVoiceStatus('Testing voice...', 'listening');
            
            let testMessage;
            switch(currentLanguage) {
                case 'en':
                    testMessage = "Hello! This is a voice test. If you can hear me, the speech synthesis is working correctly!";
                    break;
                case 'vi':
                    testMessage = "Xin chào! Đây là bài kiểm tra giọng nói. Nếu bạn có thể nghe thấy tôi, tổng hợp giọng nói đang hoạt động chính xác!";
                    break;
                case 'ur':
                    testMessage = "ہیلو! یہ آواز کی جانچ ہے۔ اگر آپ مجھے سن سکتے ہیں، تو سپیچ سنتھیسس صحیح طریقے سے کام کر رہا ہے!";
                    break;
                default:
                    testMessage = "Hello! This is a voice test. If you can hear me, the speech synthesis is working correctly!";
            }
            
            console.log('Testing voice with message:', testMessage);
            console.log('Available voices:', window.speechSynthesis.getVoices());
            
            speak(testMessage);
        });

        continuousModeBtn.addEventListener('click', () => {
            continuousMode = !continuousMode;
            continuousModeBtn.innerHTML = continuousMode ? 
                `<i class="fas fa-comment-slash"></i> ${currentLangData.continuousModeText}` : 
                `<i class="fas fa-comments"></i> ${currentLangData.continuousModeText}`;
            status.textContent = continuousMode ? 'Continuous mode enabled!' : 'Continuous mode disabled';
            setExpression(continuousMode ? 'excited' : 'neutral', continuousMode ? 'Continuous mode' : 'Ready');
            
            updateUIText(); // Update button text
        });

        // Auto Chat Functionality
        function toggleAutoChat() {
            autoChatActive = !autoChatActive;
            autoChatBtn.innerHTML = autoChatActive ? 
                `<i class="fas fa-stop"></i> ${currentLangData.autoChatText}` : 
                `<i class="fas fa-robot"></i> ${currentLangData.autoChatText}`;
            
            if (autoChatActive) {
                status.textContent = 'Auto chat mode activated!';
                setExpression('excited', currentLangData.autoChatActiveExpression);
                startAutoChat();
            } else {
                status.textContent = 'Auto chat mode deactivated';
                setExpression('neutral', currentLangData.readyExpression);
                stopAutoChat();
            }
            
            updateUIText(); // Update button text
        }

        function startAutoChat() {
            const autoQuestions = {
                'en': [
                    "What's your favorite hobby?",
                    "Tell me about your day!",
                    "What kind of music do you like?",
                    "Do you have any pets?",
                    "What's your favorite food?",
                    "Have you traveled anywhere interesting?",
                    "What do you do for fun?",
                    "What's the best book you've read recently?"
                ],
                'vi': [
                    "Sở thích của bạn là gì?",
                    "Hãy kể cho tôi nghe về ngày của bạn!",
                    "Bạn thích loại nhạc nào?",
                    "Bạn có nuôi thú cưng không?",
                    "Món ăn yêu thích của bạn là gì?",
                    "Bạn đã đi du lịch đến nơi nào thú vị chưa?",
                    "Bạn làm gì để giải trí?",
                    "Cuốn sách hay nhất bạn đã đọc gần đây là gì?"
                ],
                'ur': [
                    "آپ کا پسندیدہ مشغلہ کیا ہے؟",
                    "اپنے دن کے بارے میں بتائیں!",
                    "آپ کس قسم کا موسیقی پسند کرتے ہیں؟",
                    "کیا آپ کے پاس کوئی پالتو جانور ہیں؟",
                    "آپ کا پسندیدہ کھانا کیا ہے؟",
                    "کیا آپ نے کسی دلچسپ جگہ سفر کیا ہے؟",
                    "آپ تفریح کے لیے کیا کرتے ہیں؟",
                    "آپ نے حال ہی میں پڑھی ہوئی بہترین کتاب کون سی ہے؟"
                ]
            };
            
            autoChatInterval = setInterval(() => {
                if (autoChatActive) {
                    const questions = autoQuestions[currentLanguage] || autoQuestions['en'];
                    const randomQuestion = questions[Math.floor(Math.random() * questions.length)];
                    addChatMessage(randomQuestion, "robot");
                    setExpression('thinking', currentLangData.processingExpression);
                    
                    // Simulate user response after a delay
                    setTimeout(() => {
                        if (autoChatActive) {
                            const userResponses = {
                                'en': [
                                    "That's an interesting question!",
                                    "I'm not sure how to answer that.",
                                    "Let me think about that for a moment.",
                                    "That's a great topic to discuss!",
                                    "I'd love to share more about that."
                                ],
                                'vi': [
                                    "Đó là một câu hỏi thú vị!",
                                    "Tôi không chắc làm thế nào để trả lời điều đó.",
                                    "Hãy để tôi suy nghĩ về điều đó một lúc.",
                                    "Đó là một chủ đề tuyệt vời để thảo luận!",
                                    "Tôi rất muốn chia sẻ thêm về điều đó."
                                ],
                                'ur': [
                                    "یہ ایک دلچسپ سوال ہے!",
                                    "مجھے یقین نہیں ہے کہ اس کا جواب کیسے دوں۔",
                                    "مجھے اس پر تھوڑی دیر سوچنے دیں۔",
                                    "یہ بات چیت کرنے کا ایک بہترین موضوع ہے!",
                                    "میں اس کے بارے میں مزید شیئر کرنا پسند کروں گا۔"
                                ]
                            };
                            
                            const responses = userResponses[currentLanguage] || userResponses['en'];
                            const randomResponse = responses[Math.floor(Math.random() * responses.length)];
                            addChatMessage(randomResponse, "user");
                            
                            // AI response after user "response"
                            setTimeout(() => {
                                if (autoChatActive) {
                                    const aiFollowUps = {
                                        'en': [
                                            "Thanks for sharing that with me!",
                                            "That sounds really interesting!",
                                            "I appreciate you telling me that.",
                                            "That's wonderful to hear!",
                                            "I'd love to learn more about that sometime."
                                        ],
                                        'vi': [
                                            "Cảm ơn bạn đã chia sẻ điều đó với tôi!",
                                            "Nghe thật thú vị!",
                                            "Tôi đánh giá cao bạn đã nói với tôi điều đó.",
                                            "Thật tuyệt vời khi nghe điều đó!",
                                            "Tôi rất muốn tìm hiểu thêm về điều đó vào lúc nào đó."
                                        ],
                                        'ur': [
                                            "مجھے یہ شیئر کرنے کا شکریہ!",
                                            "یہ واقعی دلچسپ لگ رہا ہے!",
                                            "میں آپ کا اس کے بارے میں بتانے کی تعریف کرتا ہوں۔",
                                            "یہ سن کر بہت اچھا لگا!",
                                            "میں کسی وقت اس کے بارے میں مزید جاننا پسند کروں گا۔"
                                        ]
                                    };
                                    
                                    const followUps = aiFollowUps[currentLanguage] || aiFollowUps['en'];
                                    const randomFollowUp = followUps[Math.floor(Math.random() * followUps.length)];
                                    robotResponse(randomFollowUp);
                                }
                            }, 2000);
                        }
                    }, 3000);
                }
            }, 8000);
        }

        function stopAutoChat() {
            if (autoChatInterval) {
                clearInterval(autoChatInterval);
                autoChatInterval = null;
            }
        }

        // Main Processing Function
        async function processInstruction(instruction) {
            instruction = instruction.toLowerCase();
            status.textContent = `${currentLangData.processingStatus}: "${instruction}"`;
            setExpression('thinking', currentLangData.processingExpression);
            
            conversationHistory.push({ role: "user", content: instruction });
            
            let matched = false;
            for (const [category, data] of Object.entries(knowledgeBase)) {
                if (data.patterns) {
                    for (const pattern of data.patterns) {
                        if (instruction.includes(pattern)) {
                            matched = true;
                            if (category === 'math' && data.calculate) {
                                const response = data.calculate(instruction);
                                setExpression(data.expression, currentLangData.processingExpression);
                                robotResponse(response);
                            } else if (category === 'weather' && data.getWeather) {
                                // Handle weather asynchronously
                                setExpression(data.expression, currentLangData.processingExpression);
                                try {
                                    const weatherResponse = await data.getWeather();
                                    robotResponse(weatherResponse);
                                } catch (error) {
                                    console.error('Weather error:', error);
                                    robotResponse("I'm having trouble getting weather information right now. Please try again later.");
                                }
                            } else {
                                const response = data.responses[Math.floor(Math.random() * data.responses.length)];
                                setExpression(data.expression, currentLangData.respondingExpression);
                                robotResponse(response);
                            }
                            break;
                        }
                    }
                    if (matched) break;
                }
            }
            
            if (!matched) {
                if (aiConfig.enabled) {
                    sendToAI(instruction);
                } else {
                    const response = processWithFallback(instruction);
                    robotResponse(response);
                }
            }
            
            instructionInput.value = '';
        }

        function sendChatMessage() {
            const message = chatInput.value.trim();
            if (!message) return;
            
            addChatMessage(message, "user");
            chatInput.value = '';
            
            // Add to conversation history
            conversationHistory.push({ role: "user", content: message });
            
            // Show typing indicator
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'message robot-message typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            setExpression('thinking', currentLangData.processingExpression);
            
            // Send to appropriate system
            if (aiConfig.enabled) {
                sendToAI(message);
            } else {
                setTimeout(() => {
                    removeTypingIndicator();
                    const response = processWithFallback(message);
                    robotResponse(response);
                }, 1000);
            }
        }

        // AI API Functions
        async function sendToAI(message) {
            if (!aiConfig.enabled || !navigator.onLine) {
                const response = processWithFallback(message);
                robotResponse(response);
                return;
            }
            
            try {
                let aiResponse;
                
                switch(aiConfig.provider) {
                    case 'openai':
                        aiResponse = await callOpenAI(message);
                        break;
                    case 'groq':
                        aiResponse = await callGroq(message);
                        break;
                    default:
                        aiResponse = processWithFallback(message);
                }
                
                robotResponse(aiResponse);
                
            } catch (error) {
                console.error('AI API error:', error);
                aiConfig.enabled = false;
                checkAIStatus();
                const response = processWithFallback(message);
                robotResponse(response);
                status.textContent = 'Using local AI system';
                setExpression('sad', 'AI system offline');
            }
        }

        // Groq API Function
        async function callGroq(message) {
            const response = await fetch('https://api.groq.com/openai/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: "llama3-8b-8192",
                    messages: [
                        { 
                            role: "system", 
                            content: "You are a friendly AI assistant with animated facial expressions. Keep responses under 200 characters and be conversational." 
                        },
                        { role: "user", content: message }
                    ],
                    max_tokens: 250,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                throw new Error(`Groq API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // OpenAI API Function
        async function callOpenAI(message) {
            const messages = [
                { 
                    role: "system", 
                    content: "You are a friendly AI assistant with animated facial expressions. Keep responses under 200 characters and be conversational." 
                },
                ...conversationHistory.slice(-6)
            ];
            
            const response = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${aiConfig.apiKey}`
                },
                body: JSON.stringify({
                    model: "gpt-3.5-turbo",
                    messages: messages,
                    max_tokens: 200,
                    temperature: 0.7
                })
            });
            
            if (!response.ok) {
                throw new Error(`OpenAI API error: ${response.status}`);
            }
            
            const data = await response.json();
            return data.choices[0].message.content;
        }

        // Response System
        function robotResponse(message) {
            removeTypingIndicator();
            addChatMessage(message, "robot");
            conversationHistory.push({ role: "assistant", content: message });
            
            const expression = analyzeExpressionFromText(message);
            setExpression(expression, currentLangData.respondingExpression);
            
            speak(message);
            
            if (continuousMode) {
                setTimeout(() => {
                    setExpression('thinking', currentLangData.processingExpression);
                    status.textContent = currentLangData.processingStatus;
                }, 2000);
            }
        }

        function analyzeExpressionFromText(text) {
            const lowerText = text.toLowerCase();
            
            // Analyze sentiment and content to determine expression
            if (lowerText.includes('?') || lowerText.includes('how') || lowerText.includes('what') || lowerText.includes('why')) {
                return 'thinking';
            }
            
            if (lowerText.includes('!') || lowerText.includes('amazing') || lowerText.includes('wow') || lowerText.includes('great')) {
                return 'excited';
            }
            
            if (lowerText.includes('sad') || lowerText.includes('sorry') || lowerText.includes('unfortunately')) {
                return 'sad';
            }
            
            if (lowerText.includes('surprise') || lowerText.includes('unexpected') || lowerText.includes('shock')) {
                return 'surprised';
            }
            
            if (lowerText.includes('confused') || lowerText.includes('not sure') || lowerText.includes('don\'t know')) {
                return 'confused';
            }
            
            // Default to happy for positive responses
            return 'happy';
        }

        function processWithFallback(message) {
            const lowerMessage = message.toLowerCase();
            
            // Check knowledge base
            for (const [category, data] of Object.entries(knowledgeBase)) {
                if (data.patterns) {
                    for (const pattern of data.patterns) {
                        if (lowerMessage.includes(pattern)) {
                            if (category === 'math' && data.calculate) {
                                return data.calculate(lowerMessage);
                            }
                            return data.responses[Math.floor(Math.random() * data.responses.length)];
                        }
                    }
                }
            }
            
            // Use unknown responses
            return knowledgeBase.unknown.responses[Math.floor(Math.random() * knowledgeBase.unknown.responses.length)];
        }

        function removeTypingIndicator() {
            const typingIndicator = document.querySelector('.typing-indicator');
            if (typingIndicator) {
                typingIndicator.remove();
            }
        }

        function addChatMessage(message, sender) {
            const messageElement = document.createElement('div');
            messageElement.className = `message ${sender}-message`;
            messageElement.textContent = message;
            
            if (sender === 'robot' && !aiConfig.enabled && Math.random() > 0.7) {
                const notice = document.createElement('div');
                notice.className = 'fallback-notice';
                notice.innerHTML = '<i class="fas fa-microchip"></i> Local AI Response';
                messageElement.appendChild(notice);
            } else if (sender === 'robot' && aiConfig.enabled) {
                const notice = document.createElement('div');
                notice.className = 'fallback-notice';
                notice.style.background = 'rgba(76, 175, 80, 0.2)';
                notice.style.borderLeftColor = '#4ade80';
                notice.innerHTML = `<i class="fas fa-bolt"></i> ${aiConfig.provider.toUpperCase()} AI Response`;
                messageElement.appendChild(notice);
            }
            
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        // Text-to-Speech with lip sync - FIXED VERSION
        function speak(text) {
            if (!speechSupported) {
                console.log('Speech synthesis not supported');
                return;
            }
            
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
            }
            
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.rate = 0.9;
            utterance.pitch = 1.1;
            utterance.volume = 1.0;
            
            // Set language for speech synthesis - FIXED
            let langCode;
            switch(currentLanguage) {
                case 'en': langCode = 'en-US'; break;
                case 'vi': langCode = 'vi-VN'; break;
                case 'ur': langCode = 'ur-PK'; break;
                default: langCode = 'en-US';
            }
            utterance.lang = langCode;
            
            // Wait for voices to be loaded
            const voices = window.speechSynthesis.getVoices();
            if (voices.length === 0) {
                // If voices aren't loaded yet, wait and try again
                window.speechSynthesis.onvoiceschanged = () => {
                    const loadedVoices = window.speechSynthesis.getVoices();
                    setVoiceForUtterance(utterance, loadedVoices, langCode);
                    speakUtterance(utterance);
                };
                return;
            }
            
            setVoiceForUtterance(utterance, voices, langCode);
            speakUtterance(utterance);
        }

        function setVoiceForUtterance(utterance, voices, langCode) {
            // Try to find a voice that matches the current language
            let matchingVoice = voices.find(voice => 
                voice.lang === langCode || 
                voice.lang.startsWith(currentLanguage) ||
                (currentLanguage === 'en' && voice.lang.includes('en')) ||
                (currentLanguage === 'vi' && voice.lang.includes('vi')) ||
                (currentLanguage === 'ur' && voice.lang.includes('ur'))
            );
            
            if (matchingVoice) {
                utterance.voice = matchingVoice;
                console.log('Using voice:', matchingVoice.name, 'for language:', langCode);
            } else {
                // Fallback to any available voice
                const femaleVoice = voices.find(voice => 
                    voice.name.includes('Female') || 
                    voice.name.includes('female') ||
                    voice.name.includes('Samantha') ||
                    voice.name.includes('Karen') ||
                    voice.name.includes('Victoria') ||
                    voice.name.includes('Google') ||
                    voice.name.includes('Microsoft')
                );
                if (femaleVoice) {
                    utterance.voice = femaleVoice;
                    console.log('Using fallback voice:', femaleVoice.name);
                } else if (voices.length > 0) {
                    utterance.voice = voices[0];
                    console.log('Using default voice:', voices[0].name);
                }
            }
        }

        function speakUtterance(utterance) {
            utterance.onstart = () => {
                isTalking = true;
                status.textContent = currentLangData.speakingStatus;
                mouth.classList.add('talking');
                humanFace.classList.add('face-talking');
                console.log('Speech started');
            };
            
            utterance.onend = () => {
                isTalking = false;
                status.textContent = currentLangData.readyStatus;
                mouth.classList.remove('talking');
                humanFace.classList.remove('face-talking');
                console.log('Speech ended');
            };
            
            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                isTalking = false;
                status.textContent = 'Speech error';
                mouth.classList.remove('talking');
                humanFace.classList.remove('face-talking');
            };
            
            window.speechSynthesis.speak(utterance);
            console.log('Speaking:', utterance.text);
        }

        // Language dropdown toggle
        languageBtn.addEventListener('click', () => {
            languageDropdown.classList.toggle('show');
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            if (!languageBtn.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageDropdown.classList.remove('show');
            }
        });

        // Language selection
        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', () => {
                const langCode = option.dataset.lang;
                changeLanguage(langCode);
                languageDropdown.classList.remove('show');
            });
        });

        // Initialize with greeting
        setTimeout(() => {
            addChatMessage(currentLangData.welcomeMessage, "robot");
            updateVoiceStatus('Voice system ready. Click "Voice Command" to speak.', 'ready');
        }, 1000);

        // Initialize the app
        initializeApp();

        // Service Worker Registration for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('/sw.js')
                .then(function(registration) {
                    console.log('ServiceWorker registration successful with scope: ', registration.scope);
                })
                .catch(function(err) {
                    console.log('ServiceWorker registration failed: ', err);
                });
            });
        }
    </script>
</body>
</html>
